<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agesa ÃœrÃ¼n SimÃ¼latÃ¶rÃ¼ - PDF Modu</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
  body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; }
  
  /* Ãœst Bar TasarÄ±mÄ± */
  .header-bar { background: linear-gradient(90deg, #bf2d30 0%, #a61a1d 100%); color: white; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  .header-bar h1 { margin: 0; font-size: 22px; font-weight: 600; letter-spacing: 0.5px; }
  .badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 12px; }

  .container { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; height: calc(100vh - 70px); box-sizing: border-box; }

  /* Sol Panel */
  .sidebar { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
  
  .input-group { margin-bottom: 5px; }
  .input-group label { display: block; font-weight: 600; font-size: 13px; color: #65676b; margin-bottom: 6px; }
  
  input[type="password"], select { width: 100%; padding: 12px; border: 1px solid #dddfe2; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border 0.2s; }
  input:focus, select:focus { border-color: #bf2d30; outline: none; }

  /* Ã–zel Dosya YÃ¼kleme AlanÄ± */
  .file-upload-box { border: 2px dashed #bf2d30; background: #fff5f5; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; position: relative; transition: all 0.2s; }
  .file-upload-box:hover { background: #ffebeb; }
  .file-upload-box p { margin: 10px 0 0; font-size: 13px; color: #bf2d30; font-weight: 600; }
  .file-upload-box input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
  
  .btn-primary { background: #bf2d30; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; width: 100%; margin-top: 10px; transition: background 0.2s; }
  .btn-primary:hover { background: #961518; }
  
  .log-console { background: #242526; color: #b0b3b8; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 11px; flex-grow: 1; overflow-y: auto; margin-top: 10px; max-height: 200px; }
  .log-line { border-bottom: 1px solid #3a3b3c; padding: 4px 0; }
  .log-ok { color: #42b72a; } .log-err { color: #f02849; } .log-inf { color: #1877f2; }

  /* SaÄŸ Panel */
  .main-content { background: white; border-radius: 12px; padding: 30px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  .empty-state { text-align: center; color: #65676b; margin-top: 100px; }
  
  .question-card { background: #f7f8fa; border: 1px solid #dddfe2; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
  .question-title { color: #1c1e21; font-weight: 700; margin-bottom: 15px; display: block; }
  .option { padding: 8px 12px; margin-bottom: 5px; background: white; border: 1px solid #ebedf0; border-radius: 6px; font-size: 14px; color: #4b4c4f; }
  
  .answer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
  .answer-item { background: #f0f2f5; padding: 10px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; font-size: 13px; font-weight: 600; }
  
  .evaluation-box { background: #e7f3ff; color: #0c3d69; padding: 20px; border-radius: 8px; margin-top: 20px; line-height: 1.6; white-space: pre-wrap; border-left: 5px solid #1877f2; }
</style>
</head>
<body>

<div class="header-bar">
  <h1>ğŸ›¡ï¸ Agesa ÃœrÃ¼n SimÃ¼latÃ¶rÃ¼</h1>
  <span class="badge">V2.0 - PDF Edition</span>
</div>

<div class="container">
  
  <div class="sidebar">
    <div class="input-group">
      <label>1. OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>

    <div class="input-group">
      <label>2. Ã‡alÄ±ÅŸma Modu</label>
      <select id="modeSelect">
        <option value="standard">ğŸ“ Ã–ÄŸretici Mod (Genel Bilgi)</option>
        <option value="hardcase">ğŸ”¥ DenetÃ§i Modu (Zorlu Vakalar)</option>
      </select>
    </div>

    <div class="input-group">
      <label>3. ÃœrÃ¼n DokÃ¼manÄ± (PDF)</label>
      <div class="file-upload-box">
        <span style="font-size: 24px;">ğŸ“„</span>
        <p>PDF YÃ¼klemek Ä°Ã§in TÄ±kla</p>
        <input type="file" id="pdfInput" accept="application/pdf" onchange="handlePDFSelection(this)">
      </div>
    </div>

    <div class="input-group">
      <label>4. Ekran GÃ¶rÃ¼ntÃ¼sÃ¼ (Opsiyonel)</label>
      <input type="file" id="imgInput" accept="image/*" multiple>
    </div>

    <button class="btn-primary" onclick="startProcess()">ANALÄ°ZÄ° BAÅLAT</button>

    <div class="log-console" id="logger">
      <div class="log-line">Sistem hazÄ±r. PDF yÃ¼kleyip baÅŸlayÄ±n...</div>
    </div>
  </div>

  <div class="main-content" id="outputArea">
    <div class="empty-state">
      <h2>HenÃ¼z Analiz Yok</h2>
      <p>Sol taraftan "PDF YÃ¼klemek Ä°Ã§in TÄ±kla" alanÄ±na basÄ±p dosyanÄ±zÄ± seÃ§in.</p>
    </div>
  </div>

</div>

<script>
// PDF Worker AyarÄ±
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

let sessionKey = "";
let questions = [];
let userAnswers = {};

function log(msg, type) {
  const box = document.getElementById("logger");
  const div = document.createElement("div");
  div.className = `log-line log-${type}`;
  div.innerText = `> ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

// PDF SeÃ§ildiÄŸinde Ã‡alÄ±ÅŸacak Fonksiyon
function handlePDFSelection(input) {
  if (input.files && input.files[0]) {
    log("PDF SeÃ§ildi: " + input.files[0].name, "inf");
  }
}

// PDF METÄ°N Ã‡IKARMA (Otomatik)
async function parsePDF(file) {
  log("PDF okunuyor...", "inf");
  try {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(buffer).promise;
    let fullText = "";
    
    log(`Toplam ${pdf.numPages} sayfa tespit edildi.`, "inf");

    for(let i=1; i<=pdf.numPages; i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const strings = content.items.map(item => item.str);
      fullText += `\n--- Sayfa ${i} ---\n` + strings.join(" ");
    }
    
    if(fullText.length < 50) {
      log("UYARI: PDF'ten metin okunamadÄ± (Resim formatÄ±nda olabilir).", "err");
    } else {
      log(`PDF baÅŸarÄ±yla okundu (${fullText.length} karakter).`, "ok");
    }
    return fullText;
  } catch(e) {
    log("PDF HatasÄ±: " + e.message, "err");
    throw e;
  }
}

function toBase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(file);
  });
}

// ANA Ä°ÅLEM BAÅLATMA
async function startProcess() {
  // Temizlik
  document.getElementById("outputArea").innerHTML = '<div class="empty-state"><h3>Analiz Ediliyor...</h3><p>LÃ¼tfen bekleyiniz, yapay zeka dokÃ¼manÄ± okuyor.</p></div>';
  questions = [];
  userAnswers = {};

  const key = document.getElementById("apiKey").value.trim();
  const pdfFile = document.getElementById("pdfInput").files[0];
  const imgFiles = document.getElementById("imgInput").files;
  const mode = document.getElementById("modeSelect").value;

  if(!key) { log("LÃ¼tfen API Key giriniz!", "err"); return; }
  sessionKey = key;

  if(!pdfFile && imgFiles.length === 0) { log("LÃ¼tfen Ã¶nce bir PDF dosyasÄ± seÃ§in.", "err"); return; }

  try {
    let extractedText = "";
    if(pdfFile) extractedText = await parsePDF(pdfFile);
    
    let imageList = [];
    if(imgFiles.length > 0) {
      for(let f of imgFiles) imageList.push(await toBase64(f));
      log(`${imageList.length} gÃ¶rsel iÅŸlendi.`, "ok");
    }

    // Prompt HazÄ±rlÄ±ÄŸÄ±
    let promptText = "";
    if(mode === "hardcase") {
      promptText = `Sen uzman bir sigorta denetÃ§isisin. AmacÄ±n aÃ§Ä±klarÄ± bulmak. 
      AÅŸaÄŸÄ±daki sigorta dokÃ¼manÄ±nÄ± analiz et ve kullanÄ±cÄ±yÄ± zorlayacak 5 adet "Vaka Analizi" (Case Study) sorusu Ã¼ret.
      Sorular Ã¶zellikle "Kapsam DÄ±ÅŸÄ± Haller", "Ã–zel Åartlar" ve "Limitler" ile ilgili olsun.
      Basit tanÄ±m sorularÄ± sorma. Senaryo kur.`;
    } else {
      promptText = `Bu sigorta Ã¼rÃ¼nÃ¼nÃ¼ analiz et. ÃœrÃ¼nÃ¼ Ã¶ÄŸrenmek isteyen bir personel iÃ§in 10 adet kaliteli, Ã¶ÄŸretici Ã§oktan seÃ§meli soru hazÄ±rla.`;
    }

    const messages = [
      {
        role: "user",
        content: [
          { type: "text", text: `${promptText}\n\nÃ‡IKTI FORMATI: Sadece JSON Array dÃ¶ndÃ¼r. Markdown kullanma. Format: [{"question":"...","options":["A)...","B)..."]}] \n\nDOKÃœMAN Ä°Ã‡ERÄ°ÄÄ°:\n${extractedText.substring(0, 40000)}` },
          ...imageList.map(img => ({ type: "image_url", image_url: { url: `data:image/jpeg;base64,${img}` } }))
        ]
      }
    ];

    log("OpenAI'a gÃ¶nderiliyor...", "inf");
    
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${sessionKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o", messages: messages, temperature: 0.5 })
    });

    if(!response.ok) throw new Error("API HatasÄ±: " + response.statusText);

    const data = await response.json();
    let content = data.choices[0].message.content.replace(/```json|```/g, "").trim();
    
    try {
      let parsed = JSON.parse(content);
      if(parsed.questions) parsed = parsed.questions;
      if(parsed.sorular) parsed = parsed.sorular;
      questions = parsed;
    } catch(e) {
      throw new Error("JSON Format HatasÄ±. Tekrar deneyin.");
    }

    log(`${questions.length} soru oluÅŸturuldu.`, "ok");
    renderUI();

  } catch(e) {
    log("Hata: " + e.message, "err");
    document.getElementById("outputArea").innerHTML = `<div class="empty-state" style="color:red"><h3>Hata OluÅŸtu</h3><p>${e.message}</p></div>`;
  }
}

function renderUI() {
  const area = document.getElementById("outputArea");
  area.innerHTML = `<h2>Sorular</h2>`;
  
  questions.forEach((q, i) => {
    area.innerHTML += `
      <div class="question-card">
        <span class="question-title">${i+1}. ${q.question}</span>
        ${q.options.map(opt => `<div class="option">${opt}</div>`).join('')}
        
        <div class="answer-grid" style="border:none; padding:0; margin-top:10px">
           ${['A','B','C','D','E'].map(L => `
             <div class="answer-item">
               <label style="cursor:pointer; width:100%; display:block">
                 <input type="radio" name="q${i}" onchange="userAnswers[${i+1}]='${L}'"> ${L}
               </label>
             </div>
           `).join('')}
        </div>
      </div>
    `;
  });

  area.innerHTML += `<button class="btn-primary" style="background:#10b981" onclick="evaluateAnswers()">CEVAPLARI DEÄERLENDÄ°R</button>`;
  area.innerHTML += `<div id="evalBox"></div>`;
}

async function evaluateAnswers() {
  log("Cevaplar deÄŸerlendiriliyor...", "inf");
  const prompt = `Sorular: ${JSON.stringify(questions)}\nKullanÄ±cÄ± CevaplarÄ±: ${JSON.stringify(userAnswers)}\n\nLÃ¼tfen detaylÄ± analiz yap. DoÄŸru cevaplarÄ± aÃ§Ä±kla ve kullanÄ±cÄ± hatalarÄ±nÄ± dÃ¼zelt. 100 Ã¼zerinden puan ver.`;
  
  const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${sessionKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "user", content: prompt }], temperature: 0.3 })
  });

  const data = await response.json();
  document.getElementById("evalBox").innerHTML = `<div class="evaluation-box">${data.choices[0].message.content}</div>`;
  log("DeÄŸerlendirme tamamlandÄ±.", "ok");
}
</script>
</body>
</html>
