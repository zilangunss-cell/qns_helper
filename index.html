<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agesa ÃœrÃ¼n SimÃ¼latÃ¶rÃ¼ - V4 (KanÄ±tlÄ±)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
  body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; }
  
  .header-bar { background: linear-gradient(90deg, #bf2d30 0%, #a61a1d 100%); color: white; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  .header-bar h1 { margin: 0; font-size: 22px; font-weight: 600; letter-spacing: 0.5px; }
  .badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 12px; }

  .container { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; height: calc(100vh - 70px); box-sizing: border-box; }

  /* Sol Panel */
  .sidebar { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
  
  .input-group label { display: block; font-weight: 600; font-size: 13px; color: #65676b; margin-bottom: 6px; }
  input[type="password"], select { width: 100%; padding: 12px; border: 1px solid #dddfe2; border-radius: 8px; font-size: 14px; box-sizing: border-box; }

  .file-upload-box { border: 2px dashed #bf2d30; background: #fff5f5; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; position: relative; transition: all 0.2s; }
  .file-upload-box:hover { background: #ffebeb; }
  .file-upload-box input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
  
  .btn-primary { background: #bf2d30; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; width: 100%; margin-top: 10px; }
  .btn-primary:hover { background: #961518; }
  
  .log-console { background: #242526; color: #b0b3b8; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 11px; flex-grow: 1; overflow-y: auto; margin-top: 10px; max-height: 200px; }
  .log-line { border-bottom: 1px solid #3a3b3c; padding: 4px 0; }
  .log-ok { color: #42b72a; } .log-err { color: #f02849; } .log-inf { color: #1877f2; }

  /* SaÄŸ Panel */
  .main-content { background: white; border-radius: 12px; padding: 30px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  
  .question-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
  .question-title { color: #111827; font-weight: 700; margin-bottom: 15px; display: block; font-size: 17px; line-height: 1.5; }
  
  .answer-item { 
    background: #f9fafb; padding: 12px 15px; border: 1px solid #e5e7eb; border-radius: 8px; 
    margin-bottom: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center;
  }
  .answer-item:hover { background: #f3f4f6; border-color: #d1d5db; }
  .answer-item.selected { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }
  
  /* SonuÃ§ GÃ¶sterimi Stilleri */
  .answer-item.correct { background: #dcfce7 !important; border-color: #22c55e !important; color: #166534 !important; }
  .answer-item.wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; opacity: 0.8; }
  
  .proof-box { 
    margin-top: 15px; padding: 15px; background: #fffbeb; border-left: 4px solid #f59e0b; 
    border-radius: 4px; font-size: 14px; color: #92400e; display: none; line-height: 1.5;
  }
  .proof-box strong { display: block; margin-bottom: 5px; color: #b45309; }
</style>
</head>
<body>

<div class="header-bar">
  <h1>ğŸ›¡ï¸ Agesa ÃœrÃ¼n SimÃ¼latÃ¶rÃ¼</h1>
  <span class="badge">V4.0 - KanÄ±tlÄ± Sistem</span>
</div>

<div class="container">
  
  <div class="sidebar">
    <div class="input-group">
      <label>1. OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>

    <div class="input-group">
      <label>2. Soru Tipi</label>
      <select id="modeSelect">
        <option value="strict">ğŸ¯ KanÄ±ta DayalÄ± (Sadece PDF'tekiler)</option>
        <option value="hardcase">ğŸ”¥ ZorlayÄ±cÄ± Senaryolar</option>
      </select>
    </div>

    <div class="input-group">
      <label>3. ÃœrÃ¼n DokÃ¼manlarÄ± (PDF)</label>
      <div class="file-upload-box">
        <span style="font-size: 24px;">ğŸ“„</span>
        <p>PDF'leri SeÃ§mek Ä°Ã§in TÄ±kla</p>
        <small style="color:#999">(CTRL ile Ã§oklu seÃ§im)</small>
        <input type="file" id="pdfInput" accept="application/pdf" multiple onchange="handleFiles(this)">
      </div>
      <div id="fileList" style="font-size:12px; margin-top:5px; color:#666"></div>
    </div>

    <button class="btn-primary" onclick="startProcess()">ANALÄ°ZÄ° BAÅLAT</button>
    <div class="log-console" id="logger"><div class="log-line">Sistem hazÄ±r.</div></div>
  </div>

  <div class="main-content" id="outputArea">
    <div style="text-align:center; margin-top:100px; color:#6b7280">
      <h3>Bekleniyor...</h3>
      <p>LÃ¼tfen sol taraftan dokÃ¼man yÃ¼kleyip baÅŸlatÄ±n.</p>
    </div>
  </div>

</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

let sessionKey = "";
let questions = []; // ArtÄ±k iÃ§inde doÄŸru cevap ve kanÄ±t da olacak
let userAnswers = {};

function log(msg, type) {
  const box = document.getElementById("logger");
  const div = document.createElement("div");
  div.className = `log-line log-${type}`;
  div.innerText = `> ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function handleFiles(input) {
  const list = document.getElementById("fileList");
  if (input.files.length > 0) {
    list.innerHTML = Array.from(input.files).map(f => "â€¢ " + f.name).join("<br>");
    log(`${input.files.length} dosya seÃ§ildi.`, "inf");
  }
}

async function parsePDF(file) {
  log(`Okunuyor: ${file.name}`, "inf");
  try {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(buffer).promise;
    let fullText = "";
    for(let i=1; i<=pdf.numPages; i++){
      const page = await pdf.getPage(i);
      const text = await page.getTextContent();
      fullText += `\n[Sayfa ${i}] ` + text.items.map(s => s.str).join(" ");
    }
    return fullText;
  } catch(e) {
    log("Hata: " + e.message, "err");
    return "";
  }
}

async function startProcess() {
  const area = document.getElementById("outputArea");
  area.innerHTML = '<div style="text-align:center;margin-top:50px"><h3>Analiz YapÄ±lÄ±yor...</h3><p>DokÃ¼man taranÄ±yor ve kanÄ±tlÄ± sorular Ã¼retiliyor.</p></div>';
  
  questions = [];
  userAnswers = {};

  // API Key Temizle
  const rawKey = document.getElementById("apiKey").value;
  const key = rawKey.replace(/[^\x00-\x7F]/g, "").trim();
  document.getElementById("apiKey").value = key;

  if(!key) { log("API Key yok!", "err"); return; }
  const files = document.getElementById("pdfInput").files;
  if(files.length === 0) { log("Dosya yok!", "err"); return; }

  try {
    // 1. PDF OKUMA
    let combinedText = "";
    for(let i=0; i<files.length; i++) combinedText += await parsePDF(files[i]) + "\n\n";

    // 2. PROMPT (Ã‡ok SÄ±kÄ±)
    const prompt = `
    Sen bir Sigorta DenetÃ§isisin. Verilen metni analiz et ve 10 adet soru Ã¼ret.
    
    Ã‡OK Ã–NEMLÄ° KURALLAR:
    1. Sadece ve sadece metinde aÃ§Ä±kÃ§a yazan bilgileri sor. Asla tahmin yÃ¼rÃ¼tme.
    2. EÄŸer bir sÃ¼re, yaÅŸ veya limit soruyorsan, metindeki KOÅULU belirt (Ã–rn: "X planÄ±nÄ± seÃ§enler iÃ§in sÃ¼re nedir?").
    3. JSON formatÄ±nda yanÄ±t ver. Her soru iÃ§in "correct_option" (A,B,C,D,E) ve "proof" (KanÄ±t Metni) alanlarÄ±nÄ± doldurmak zorundasÄ±n.
    4. "proof" alanÄ±, o cevabÄ±n doÄŸru olduÄŸunu metinden alÄ±ntÄ±layarak gÃ¶stermelidir.
    
    Ä°stenen JSON FormatÄ±:
    [
      {
        "question": "Soru metni...",
        "options": ["A) ...", "B) ...", "C) ...", "D) ...", "E) ..."],
        "correct_option": "A",
        "proof": "Sayfa 2, Madde 3.1: 'SigortalÄ± 18 yaÅŸÄ±ndan kÃ¼Ã§Ã¼kse ebeveyn onayÄ± gerekir' ÅŸeklinde belirtilmiÅŸtir."
      }
    ]
    
    METÄ°N:
    ${combinedText.substring(0, 50000)}
    `;

    log("Yapay zekaya soruluyor...", "inf");
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o", messages: [{role:"user", content: prompt}], temperature: 0.2 }) // Temp dÃ¼ÅŸÃ¼k: Daha tutarlÄ±
    });

    if(!res.ok) throw new Error("API HatasÄ±");
    const data = await res.json();
    let content = data.choices[0].message.content.replace(/```json|```/g, "").trim();
    
    questions = JSON.parse(content);
    if(questions.questions) questions = questions.questions; // Bazen wrapper iÃ§inde dÃ¶nerse

    log(`${questions.length} soru Ã¼retildi.`, "ok");
    renderQuiz();

  } catch(e) {
    log("Hata: " + e.message, "err");
    area.innerHTML = `<h3 style="color:red">Hata OluÅŸtu</h3><p>${e.message}</p>`;
  }
}

function renderQuiz() {
  const area = document.getElementById("outputArea");
  area.innerHTML = `<h2>Sorular (${questions.length} Adet)</h2>`;
  
  questions.forEach((q, idx) => {
    let optsHTML = "";
    const letters = ["A","B","C","D","E"];
    
    q.options.forEach((opt, oIdx) => {
      const letter = letters[oIdx];
      // ÅÄ±k metninden "A)" gibi kÄ±sÄ±mlarÄ± temizleyelim, biz zaten ekliyoruz
      const cleanOpt = opt.replace(/^[A-Ea-e][\).]\s*/, "");
      
      optsHTML += `
        <div class="answer-item" id="opt_${idx}_${letter}" onclick="selectAnswer(${idx}, '${letter}')">
          <b style="color:#bf2d30; margin-right:10px; width:20px">${letter})</b> ${cleanOpt}
        </div>
      `;
    });

    area.innerHTML += `
      <div class="question-card" id="q_card_${idx}">
        <span class="question-title">${idx+1}. ${q.question}</span>
        <div>${optsHTML}</div>
        <div class="proof-box" id="proof_${idx}">
          <strong>ğŸ“œ Resmi DokÃ¼man KanÄ±tÄ±:</strong>
          ${q.proof || "KanÄ±t metni bulunamadÄ±."}
        </div>
      </div>
    `;
  });

  area.innerHTML += `<button class="btn-primary" style="background:#10b981; margin-bottom:50px" onclick="checkAnswers()">TESTÄ° BÄ°TÄ°R VE KONTROL ET</button>`;
}

function selectAnswer(qIdx, letter) {
  // GÃ¶rsel seÃ§im
  const parent = document.getElementById(`q_card_${qIdx}`);
  const items = parent.querySelectorAll('.answer-item');
  items.forEach(i => i.classList.remove('selected'));
  
  document.getElementById(`opt_${qIdx}_${letter}`).classList.add('selected');
  userAnswers[qIdx] = letter;
}

function checkAnswers() {
  let score = 0;
  questions.forEach((q, idx) => {
    const userAns = userAnswers[idx];
    const correctAns = q.correct_option.trim().toUpperCase(); // A, B vs.
    const proofBox = document.getElementById(`proof_${idx}`);
    
    // KanÄ±tÄ± gÃ¶ster
    proofBox.style.display = "block";
    
    // ÅÄ±klarÄ± boya
    const letters = ["A","B","C","D","E"];
    letters.slice(0, q.options.length).forEach(L => {
      const el = document.getElementById(`opt_${idx}_${L}`);
      
      // DoÄŸru ÅŸÄ±kkÄ± her zaman yeÅŸil yap
      if(L === correctAns) {
        el.classList.add('correct');
      }
      
      // EÄŸer kullanÄ±cÄ± yanlÄ±ÅŸ seÃ§tiyse onu kÄ±rmÄ±zÄ± yap
      if(userAns === L && userAns !== correctAns) {
        el.classList.add('wrong');
      }
    });

    if(userAns === correctAns) score++;
  });

  // Skoru en Ã¼ste yaz
  window.scrollTo(0,0);
  alert(`Test TamamlandÄ±!\nDoÄŸru SayÄ±sÄ±: ${score} / ${questions.length}`);
}
</script>
</body>
</html>
