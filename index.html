<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Agesa √úr√ºn Uzmanlƒ±k Sim√ºlat√∂r√º</title>

<style>
body{margin:0;font-family:system-ui;background:#f2f4f7;color:#333}
.container{display:grid;grid-template-columns:40% 60%;height:100vh;gap:16px;padding:16px;box-sizing:border-box}
.panel{background:#fff;border-radius:14px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,.08);position:relative;display:flex;flex-direction:column}
.scrollable{overflow-y:auto;flex-grow:1}
.question{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:16px;background:#fafafa}
.question b{color:#1e3a8a;display:block;margin-bottom:8px}
.options{margin-top:10px}
label{font-weight:600;font-size:13px;color:#64748b;margin-bottom:4px;display:block;margin-top:12px}
input[type="text"], input[type="password"], textarea, select {width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px;box-sizing:border-box;font-family:inherit}
textarea{resize:vertical;min-height:80px}
button{margin-top:16px;width:100%;padding:12px;background:#2563eb;color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:background 0.2s}
button:hover{background:#1d4ed8}
.secondary{background:#10b981}
.secondary:hover{background:#059669}
.log-panel{background:#0f172a;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;height:150px;overflow-y:auto;margin-top:auto}
.tab-header{display:flex;gap:10px;margin-bottom:8px;border-bottom:1px solid #334155;padding-bottom:5px}
.tab-header span{cursor:pointer;font-weight:600;opacity:0.6}
.tab-header span.active-tab{opacity:1;color:#38bdf8}
.tab{display:none}
.tab.active{display:block}
.log.ok{color:#4ade80}
.log.info{color:#38bdf8}
.log.error{color:#f87171}
hr{border:0;border-top:1px solid #e2e8f0;margin:20px 0}
</style>
</head>

<body>
<div class="container">

<div class="panel">
  <h2 style="margin-top:0;color:#111">√úr√ºn Analiz & Sim√ºlasyon</h2>

  <label>OpenAI API Key</label>
  <input id="apiKey" type="password" placeholder="sk-...">

  <label>Sim√ºlasyon Modu</label>
  <select id="modeSelect">
    <option value="standard">Standart Test (Genel Bilgi)</option>
    <option value="hardcase">üõ°Ô∏è Zorlu Vaka Analizi (ƒ∞stisnalar & Redler)</option>
  </select>

  <label>√úr√ºn Metni / √ñzel ≈ûartlar (PDF'ten Kopyala)</label>
  <textarea id="productText" rows="6" placeholder="√ñrn: Agesa Her ƒ∞htimalin Sigortasƒ± √∂zel ≈üartlar metnini buraya yapƒ±≈ütƒ±r..."></textarea>

  <label>Veya √úr√ºn Ekran G√∂r√ºnt√ºleri (max 5)</label>
  <input id="images" type="file" accept="image/*" multiple>

  <button onclick="generateQuestions()">Analizi Ba≈ülat</button>

  <div class="log-panel">
    <div class="tab-header">
      <span onclick="switchTab('log')" id="logTabBtn" class="active-tab">Sistem Log</span>
      <span onclick="switchTab('eval')" id="evalTabBtn">Yapay Zeka Yorumu</span>
    </div>
    <div id="logTab" class="tab active"></div>
    <div id="evalTab" class="tab"></div>
  </div>
</div>

<div class="panel">
  <div class="scrollable" id="output">
    <h2 style="margin-top:0">Sim√ºlasyon Ekranƒ±</h2>
    <p style="color:#666;text-align:center;margin-top:50px">Hen√ºz bir analiz ba≈ülatƒ±lmadƒ±.<br>Soldaki panelden veri girerek s√ºreci ba≈ülatƒ±n.</p>
  </div>
  
  <div style="border-top:1px solid #eee; padding-top:10px">
    <div id="answerPanel" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;"></div>
    <button class="secondary" id="evalBtn" onclick="evaluateAnswers()" style="display:none">Cevaplarƒ±mƒ± Deƒüerlendir</button>
  </div>
</div>

</div>

<script>
let sessionKey, questions=[];
let userAnswers={};

function log(msg,type="info"){
  const d=document.createElement("div");
  d.className="log "+type;
  d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
  const logTab = document.getElementById("logTab");
  logTab.appendChild(d);
  logTab.scrollTop = logTab.scrollHeight;
}

function switchTab(tab){
  document.getElementById("logTab").classList.remove("active");
  document.getElementById("evalTab").classList.remove("active");
  document.getElementById(tab+"Tab").classList.add("active");
  
  document.getElementById("logTabBtn").classList.remove("active-tab");
  document.getElementById("evalTabBtn").classList.remove("active-tab");
  document.getElementById(tab+"TabBtn").classList.add("active-tab");
}

function toBase64(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

// --- ANA FONKSƒ∞YON ---
async function generateQuestions(){
  document.getElementById("logTab").innerHTML="";
  document.getElementById("evalTab").innerHTML="";
  document.getElementById("evalBtn").style.display="none";
  
  sessionKey=document.getElementById("apiKey").value;
  const textVal = document.getElementById("productText").value;
  const files=[...document.getElementById("images").files];
  const mode = document.getElementById("modeSelect").value;
   
  if(!sessionKey){ 
    log("L√ºtfen API Key giriniz.", "error"); 
    return; 
  }
  
  if(files.length === 0 && textVal.trim() === ""){
    log("L√ºtfen en az bir resim y√ºkleyin VEYA √ºr√ºn metni yapƒ±≈ütƒ±rƒ±n.", "error");
    return;
  }
   
  log("Analiz ba≈ülatƒ±lƒ±yor...", "ok");

  try {
      let content = [];
      
      // 1. Mod'a g√∂re Sistem Talimatƒ± Hazƒ±rla
      let systemPrompt = "";
      if(mode === "hardcase") {
        systemPrompt = `Sen acƒ±masƒ±z bir sigorta denet√ßisisin (Auditor). 
        Verilen sigorta √ºr√ºn√º metnini/g√∂rsellerini analiz et.
        Amacƒ±n kullanƒ±cƒ±nƒ±n "ƒ∞stisnalar", "Teminat Dƒ±≈üƒ± Haller" ve "√ñzel ≈ûartlar" konusundaki bilgisini zorlamak.
        
        Bana 5 adet "Case Study" (Vaka Analizi) sorusu √ºret.
        Sorular "A≈üaƒüƒ±dakilerden hangisi kapsamdadƒ±r?" gibi basit OLMASIN.
        √ñrnek format: "Ahmet Bey X durumunu ya≈üadƒ±, Y belgesi eksik ama Z ≈üartƒ± var. Poli√ße √∂deme yapar mƒ±?"
        
        ≈ûƒ±klar detaylƒ± ve √ßeldirici olsun.`;
      } else {
        systemPrompt = `Bu sigorta √ºr√ºn√ºn√º analiz et. √úr√ºn√ºn genel kapsamƒ±, limitleri ve √∂zellikleri hakkƒ±nda 10 adet √∂ƒüretici test sorusu √ºret.`;
      }

      // 2. Format Kuralƒ± (Her iki mod i√ßin de ge√ßerli)
      const formatInstruction = `
      √áIKTI FORMATI KURALI (KESƒ∞N):
      Sadece ve sadece bir JSON Array (Dizi) d√∂nd√ºr. Markdown yok.
      Format:
      [
        {
          "question": "Soru metni...",
          "options": ["A) ...", "B) ...", "C) ...", "D) ...", "E) ..."]
        }
      ]`;

      content.push({ type: "text", text: systemPrompt + "\n\n" + formatInstruction });

      // 3. Kullanƒ±cƒ± Metni Varsa Ekle
      if(textVal.trim() !== "") {
        content.push({ type: "text", text: "√úR√úN METNƒ∞ / POLƒ∞√áE DETAYLARI:\n" + textVal });
      }

      // 4. G√∂rseller Varsa Ekle
      if(files.length > 0) {
        const imgs = await Promise.all(files.map(toBase64));
        log("G√∂rseller i≈ülendi", "ok");
        imgs.forEach(i => {
           content.push({type:"image_url",image_url:{url:"data:image/png;base64,"+i}});
        });
      }

      // API √áAƒûRISI
      const r=await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{Authorization:"Bearer "+sessionKey,"Content-Type":"application/json"},
        body:JSON.stringify({model:"gpt-4o",messages:[{role:"user",content}],temperature:0.7})
      });

      if (!r.ok) { throw new Error("API Hatasƒ±: " + r.statusText); }

      const data = await r.json();
      let raw = data.choices[0].message.content;
      
      raw = raw.replace(/```json/g, "").replace(/```/g, "").trim();

      let parsedData;
      try {
        parsedData = JSON.parse(raw);
      } catch (e) {
        // Bazen text olarak gelebilir, tekrar dene veya hata bas
        throw new Error("AI ge√ßerli JSON √ºretemedi. L√ºtfen tekrar deneyin.");
      }

      // Dizi/Obje kontrol√º
      if (!Array.isArray(parsedData) && parsedData.questions) parsedData = parsedData.questions;
      if (!Array.isArray(parsedData) && parsedData.sorular) parsedData = parsedData.sorular;

      if (!Array.isArray(parsedData)) {
          throw new Error("Format hatasƒ±. Gelen veri dizi deƒüil.");
      }

      questions = parsedData;
      userAnswers = {}; // √ñnceki cevaplarƒ± sƒ±fƒ±rla
      log(`Ba≈üarƒ±lƒ±: ${questions.length} adet sim√ºlasyon sorusu √ºretildi.`, "ok");
      
      renderQuestions();
      renderAnswerPanel();
      document.getElementById("evalBtn").style.display="block";

  } catch (err) {
      console.error(err);
      log("HATA: " + err.message, "error");
  }
}

function renderQuestions(){
  const o=document.getElementById("output");
  o.innerHTML=`<h2>${document.getElementById("modeSelect").options[document.getElementById("modeSelect").selectedIndex].text}</h2>`;
  questions.forEach((q,i)=>{
  o.innerHTML+=`
    <div class="question">
    <b>SORU ${i+1}:</b>
    <div style="margin-bottom:10px">${q.question}</div>
    ${q.options.map(op=>`<div class="option" style="padding:4px 0; border-bottom:1px solid #eee">${op}</div>`).join("")}
    </div>`;
  });
}

function renderAnswerPanel(){
  const p=document.getElementById("answerPanel");
  p.innerHTML="";
  questions.forEach((_,i)=>{
  p.innerHTML+=`
    <div style="background:#f1f5f9; padding:5px 10px; border-radius:6px; font-size:14px; display:flex; align-items:center; gap:5px">
    <strong>${i+1}.</strong>
    ${["A","B","C","D","E"].map(l=>`
      <label style="margin:0; font-weight:normal; cursor:pointer">
      <input type="radio" name="q${i}" onchange="userAnswers[${i+1}]='${l}'" style="width:auto;margin:0">${l}
      </label>`).join(" ")}
    </div>`;
  });
}

// --- D√úZELTƒ∞LMƒ∞≈û ANA FONKSƒ∞YON ---
async function generateQuestions(){
  document.getElementById("logTab").innerHTML="";
  document.getElementById("evalTab").innerHTML="";
  document.getElementById("evalBtn").style.display="none";
  
  // 1. API KEY TEMƒ∞ZLƒ∞K VE KONTROL√ú
  let rawKey = document.getElementById("apiKey").value;
  // Ba≈ütaki/sondaki bo≈üluklarƒ± sil
  sessionKey = rawKey ? rawKey.trim() : "";

  const textVal = document.getElementById("productText").value;
  const files=[...document.getElementById("images").files];
  const mode = document.getElementById("modeSelect").value;
   
  if(!sessionKey){ 
    log("L√ºtfen API Key giriniz.", "error"); 
    return; 
  }

  // T√ºrk√ße karakter veya ge√ßersiz sembol kontrol√º
  if (/[^\x00-\x7F]/.test(sessionKey)) {
    log("KRƒ∞Tƒ∞K HATA: API Key kutusunda T√ºrk√ße karakter veya ge√ßersiz sembol var. L√ºtfen silip tekrar yapƒ±≈ütƒ±rƒ±n.", "error");
    return;
  }
  
  if(files.length === 0 && textVal.trim() === ""){
    log("L√ºtfen en az bir resim y√ºkleyin VEYA √ºr√ºn metni yapƒ±≈ütƒ±rƒ±n.", "error");
    return;
  }
   
  log("Analiz ba≈ülatƒ±lƒ±yor...", "ok");

  try {
      let content = [];
      
      let systemPrompt = "";
      if(mode === "hardcase") {
        systemPrompt = `Sen acƒ±masƒ±z bir sigorta denet√ßisisin (Auditor). 
        Verilen sigorta √ºr√ºn√º metnini/g√∂rsellerini analiz et.
        Amacƒ±n kullanƒ±cƒ±nƒ±n "ƒ∞stisnalar", "Teminat Dƒ±≈üƒ± Haller" ve "√ñzel ≈ûartlar" konusundaki bilgisini zorlamak.
        
        Bana 5 adet "Case Study" (Vaka Analizi) sorusu √ºret.
        Sorular "A≈üaƒüƒ±dakilerden hangisi kapsamdadƒ±r?" gibi basit OLMASIN.
        √ñrnek format: "Ahmet Bey X durumunu ya≈üadƒ±, Y belgesi eksik ama Z ≈üartƒ± var. Poli√ße √∂deme yapar mƒ±?"
        
        ≈ûƒ±klar detaylƒ± ve √ßeldirici olsun.`;
      } else {
        systemPrompt = `Bu sigorta √ºr√ºn√ºn√º analiz et. √úr√ºn√ºn genel kapsamƒ±, limitleri ve √∂zellikleri hakkƒ±nda 10 adet √∂ƒüretici test sorusu √ºret.`;
      }

      const formatInstruction = `
      √áIKTI FORMATI KURALI (KESƒ∞N):
      Sadece ve sadece bir JSON Array (Dizi) d√∂nd√ºr. Markdown yok.
      Format:
      [
        {
          "question": "Soru metni...",
          "options": ["A) ...", "B) ...", "C) ...", "D) ...", "E) ..."]
        }
      ]`;

      content.push({ type: "text", text: systemPrompt + "\n\n" + formatInstruction });

      if(textVal.trim() !== "") {
        content.push({ type: "text", text: "√úR√úN METNƒ∞ / POLƒ∞√áE DETAYLARI:\n" + textVal });
      }

      if(files.length > 0) {
        const imgs = await Promise.all(files.map(toBase64));
        log("G√∂rseller i≈ülendi", "ok");
        imgs.forEach(i => {
           content.push({type:"image_url",image_url:{url:"data:image/png;base64,"+i}});
        });
      }

      const r=await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{Authorization:"Bearer "+sessionKey,"Content-Type":"application/json"},
        body:JSON.stringify({model:"gpt-4o",messages:[{role:"user",content}],temperature:0.7})
      });

      if (!r.ok) { 
          const errData = await r.json().catch(()=>({}));
          throw new Error("API Hatasƒ±: " + r.status + " - " + (errData.error?.message || r.statusText)); 
      }

      const data = await r.json();
      let raw = data.choices[0].message.content;
      
      raw = raw.replace(/```json/g, "").replace(/```/g, "").trim();

      let parsedData;
      try {
        parsedData = JSON.parse(raw);
      } catch (e) {
        throw new Error("AI ge√ßerli JSON √ºretemedi. L√ºtfen tekrar deneyin.");
      }

      if (!Array.isArray(parsedData) && parsedData.questions) parsedData = parsedData.questions;
      if (!Array.isArray(parsedData) && parsedData.sorular) parsedData = parsedData.sorular;

      if (!Array.isArray(parsedData)) {
          throw new Error("Format hatasƒ±. Gelen veri dizi deƒüil.");
      }

      questions = parsedData;
      userAnswers = {}; 
      log(`Ba≈üarƒ±lƒ±: ${questions.length} adet sim√ºlasyon sorusu √ºretildi.`, "ok");
      
      renderQuestions();
      renderAnswerPanel();
      document.getElementById("evalBtn").style.display="block";

  } catch (err) {
      console.error(err);
      log("HATA: " + err.message, "error");
  }
}
</script>
</body>
</html>
