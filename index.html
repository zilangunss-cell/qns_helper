<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agesa √úr√ºn Sim√ºlat√∂r√º - V3 (Detaylƒ±)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
  body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; }
  
  .header-bar { background: linear-gradient(90deg, #bf2d30 0%, #a61a1d 100%); color: white; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  .header-bar h1 { margin: 0; font-size: 22px; font-weight: 600; letter-spacing: 0.5px; }
  .badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 12px; }

  .container { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; height: calc(100vh - 70px); box-sizing: border-box; }

  .sidebar { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
  
  .input-group { margin-bottom: 5px; }
  .input-group label { display: block; font-weight: 600; font-size: 13px; color: #65676b; margin-bottom: 6px; }
  
  input[type="password"], select { width: 100%; padding: 12px; border: 1px solid #dddfe2; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border 0.2s; }
  input:focus, select:focus { border-color: #bf2d30; outline: none; }

  .file-upload-box { border: 2px dashed #bf2d30; background: #fff5f5; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; position: relative; transition: all 0.2s; }
  .file-upload-box:hover { background: #ffebeb; }
  .file-upload-box p { margin: 10px 0 0; font-size: 13px; color: #bf2d30; font-weight: 600; }
  .file-upload-box input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
  
  .file-list { font-size: 12px; color: #666; margin-top: 5px; text-align: left; }

  .btn-primary { background: #bf2d30; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; width: 100%; margin-top: 10px; transition: background 0.2s; }
  .btn-primary:hover { background: #961518; }
  
  .log-console { background: #242526; color: #b0b3b8; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 11px; flex-grow: 1; overflow-y: auto; margin-top: 10px; max-height: 200px; }
  .log-line { border-bottom: 1px solid #3a3b3c; padding: 4px 0; }
  .log-ok { color: #42b72a; } .log-err { color: #f02849; } .log-inf { color: #1877f2; }

  .main-content { background: white; border-radius: 12px; padding: 30px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  .empty-state { text-align: center; color: #65676b; margin-top: 100px; }
  
  .question-card { background: #f7f8fa; border: 1px solid #dddfe2; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
  .question-title { color: #1c1e21; font-weight: 700; margin-bottom: 15px; display: block; font-size: 16px; line-height: 1.4; }
  .option { padding: 10px 12px; margin-bottom: 8px; background: white; border: 1px solid #ebedf0; border-radius: 6px; font-size: 14px; color: #4b4c4f; }
  .option strong { color: #bf2d30; margin-right: 5px; }
  
  .answer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
  .answer-item { background: #f0f2f5; padding: 10px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
  .answer-item:hover { background: #e4e6eb; }
  .answer-item input { margin-right: 10px; cursor: pointer; }

  .evaluation-box { background: #e7f3ff; color: #0c3d69; padding: 20px; border-radius: 8px; margin-top: 20px; line-height: 1.6; white-space: pre-wrap; border-left: 5px solid #1877f2; font-size: 14px; }
</style>
</head>
<body>

<div class="header-bar">
  <h1>üõ°Ô∏è Agesa √úr√ºn Sim√ºlat√∂r√º</h1>
  <span class="badge">V3.0 - Detaylƒ± Analiz</span>
</div>

<div class="container">
  
  <div class="sidebar">
    <div class="input-group">
      <label>1. OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>

    <div class="input-group">
      <label>2. √áalƒ±≈üma Modu</label>
      <select id="modeSelect">
        <option value="detailed">üß† Detaylƒ± & Ko≈üullu Sorular (√ñnerilen)</option>
        <option value="hardcase">üî• Denet√ßi Modu (A≈üƒ±rƒ± Zor)</option>
      </select>
    </div>

    <div class="input-group">
      <label>3. √úr√ºn Dok√ºmanlarƒ± (PDF)</label>
      <div class="file-upload-box">
        <span style="font-size: 24px;">üìÑ</span>
        <p>PDF'leri Se√ßmek ƒ∞√ßin Tƒ±kla</p>
        <small style="color:#999">(CTRL ile √ßoklu se√ßim yapabilirsin)</small>
        <input type="file" id="pdfInput" accept="application/pdf" multiple onchange="handlePDFSelection(this)">
      </div>
      <div id="fileListDisplay" class="file-list"></div>
    </div>

    <div class="input-group">
      <label>4. Ekran G√∂r√ºnt√ºs√º (Opsiyonel)</label>
      <input type="file" id="imgInput" accept="image/*" multiple>
    </div>

    <button class="btn-primary" onclick="startProcess()">ANALƒ∞Zƒ∞ BA≈ûLAT</button>

    <div class="log-console" id="logger">
      <div class="log-line">Sistem hazƒ±r.</div>
    </div>
  </div>

  <div class="main-content" id="outputArea">
    <div class="empty-state">
      <h2>Hen√ºz Analiz Yok</h2>
      <p>Sol taraftan dok√ºman y√ºkleyip analizi ba≈ülatƒ±n.</p>
    </div>
  </div>

</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

let sessionKey = "";
let questions = [];
let userAnswers = {};

function log(msg, type) {
  const box = document.getElementById("logger");
  const div = document.createElement("div");
  div.className = `log-line log-${type}`;
  div.innerText = `> ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function handlePDFSelection(input) {
  const display = document.getElementById("fileListDisplay");
  if (input.files && input.files.length > 0) {
    let names = [];
    for(let i=0; i<input.files.length; i++) names.push("‚Ä¢ " + input.files[i].name);
    display.innerHTML = names.join("<br>");
    log(`${input.files.length} PDF se√ßildi.`, "inf");
  } else {
    display.innerHTML = "";
  }
}

async function parsePDF(file) {
  log(`Okunuyor: ${file.name}...`, "inf");
  try {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(buffer).promise;
    let fullText = "";
    for(let i=1; i<=pdf.numPages; i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      fullText += `\n--- [${file.name} Syf ${i}] ---\n` + content.items.map(i=>i.str).join(" ");
    }
    return fullText.length > 50 ? fullText : "";
  } catch(e) {
    log(`Hata (${file.name}): ` + e.message, "err");
    return "";
  }
}

function toBase64(file) {
  return new Promise((r) => {
    const reader = new FileReader();
    reader.onload = () => r(reader.result.split(',')[1]);
    reader.readAsDataURL(file);
  });
}

async function startProcess() {
  document.getElementById("outputArea").innerHTML = '<div class="empty-state"><h3>Analiz Ediliyor...</h3><p>Yapay zeka detaylƒ± senaryolarƒ± inceliyor...</p></div>';
  questions = [];
  userAnswers = {};

  // API Key Temizliƒüi
  let rawKey = document.getElementById("apiKey").value;
  const key = rawKey.replace(/[^\x00-\x7F]/g, "").trim();
  document.getElementById("apiKey").value = key;
  sessionKey = key;

  const pdfFiles = document.getElementById("pdfInput").files;
  const imgFiles = document.getElementById("imgInput").files;
  const mode = document.getElementById("modeSelect").value;

  if(!key) { log("L√ºtfen API Key giriniz!", "err"); return; }
  if(pdfFiles.length === 0 && imgFiles.length === 0) { log("Dosya se√ßilmedi!", "err"); return; }

  try {
    let combinedText = "";
    if(pdfFiles.length > 0) {
      for (let i = 0; i < pdfFiles.length; i++) combinedText += (await parsePDF(pdfFiles[i])) + "\n\n";
    }
    
    let imageList = [];
    if(imgFiles.length > 0) {
      for(let f of imgFiles) imageList.push(await toBase64(f));
    }

    // --- KRƒ∞Tƒ∞K PROMPT G√úNCELLEMESƒ∞ ---
    let promptText = "";
    if(mode === "hardcase") {
      promptText = `Sen uzman bir Sigorta Denet√ßisisin. Hedefimiz zorlayƒ±cƒ± senaryolar bulmak.
      G√ñREV: Dok√ºmanlardaki "ƒ∞stisnalar", "Limitler" ve "√ñzel ≈ûartlarƒ±" baz alarak 10 adet √áOK ZOR soru √ºret.
      
      KURALLAR:
      1. Asla basit soru sorma ("S√ºre ne kadar?" gibi).
      2. Daima KO≈ûUL belirt. √ñrn: "Giri≈ü ya≈üƒ± 50 olan ve X paketini se√ßen biri i√ßin s√ºre ne kadardƒ±r?"
      3. ≈ûƒ±klar birbirine √ßok yakƒ±n olsun (√áeldirici).
      4. Sorular net olsun, muallaklƒ±k olmasƒ±n.
      5. Her soru i√ßin KESƒ∞NLƒ∞KLE 5 adet ≈üƒ±k (A,B,C,D,E) √ºret.`;
    } else {
      promptText = `Sen Kƒ±demli Sigorta Eƒüitmenisin. Amacƒ±mƒ±z personelin √ºr√ºn detaylarƒ±na hakim olmasƒ±nƒ± saƒülamak.
      G√ñREV: Dok√ºmanlarƒ± analiz et ve 10 adet DETAYLI Sƒ∞M√úLASYON sorusu √ºret.
      
      KURALLAR:
      1. Muallak sorulardan ka√ßƒ±n. √ñrneƒüin "S√ºre ne kadar?" deme; "X durumunda s√ºre ne kadar?" de.
      2. Eƒüer bir cevabƒ±n birden fazla deƒüi≈ükeni varsa (ya≈ü, paket vb.), soruda bu deƒüi≈ükeni sabitle.
      3. "Her ƒ∞htimalin Sigortasƒ±" gibi √ºr√ºnlerdeki ya≈ü aralƒ±klarƒ±na ve teminat limitlerine odaklan.
      4. Her soru i√ßin KESƒ∞NLƒ∞KLE 5 adet ≈üƒ±k (A,B,C,D,E) √ºret.`;
    }

    const messages = [
      {
        role: "user",
        content: [
          { type: "text", text: `${promptText}\n\n√áIKTI FORMATI: Sadece JSON Array. Markdown yok. 
          Format: [{"question":"...","options":["A) ...","B) ...","C) ...","D) ...","E) ..."]}] 
          \n\nMETƒ∞N:\n${combinedText.substring(0, 50000)}` },
          ...imageList.map(img => ({ type: "image_url", image_url: { url: `data:image/jpeg;base64,${img}` } }))
        ]
      }
    ];

    log("OpenAI'a g√∂nderiliyor...", "inf");
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${sessionKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o", messages: messages, temperature: 0.4 })
    });

    if(!response.ok) throw new Error("API Hatasƒ±: " + response.statusText);

    const data = await response.json();
    let content = data.choices[0].message.content.replace(/```json|```/g, "").trim();
    
    let parsed = JSON.parse(content);
    questions = Array.isArray(parsed) ? parsed : (parsed.questions || parsed.sorular);
    
    log(`${questions.length} detaylƒ± soru √ºretildi.`, "ok");
    renderUI();

  } catch(e) {
    log("Hata: " + e.message, "err");
    document.getElementById("outputArea").innerHTML = `<div class="empty-state" style="color:red"><p>${e.message}</p></div>`;
  }
}

function renderUI() {
  const area = document.getElementById("outputArea");
  area.innerHTML = `<h2>Sim√ºlasyon Sorularƒ±</h2>`;
  
  const letters = ["A","B","C","D","E","F"]; // Yedekli harf havuzu

  questions.forEach((q, i) => {
    // ≈ûƒ±k sayƒ±sƒ±na g√∂re dinamik buton √ºretimi
    let optionsHTML = "";
    q.options.forEach((opt, idx) => {
        let label = letters[idx] || "?";
        optionsHTML += `
         <div class="answer-item" onclick="document.getElementById('radio_${i}_${idx}').click()">
           <div style="display:flex; align-items:center; width:100%">
             <input type="radio" id="radio_${i}_${idx}" name="q${i}" onchange="userAnswers[${i+1}]='${label}'"> 
             <span style="font-weight:bold; color:#bf2d30; margin-right:5px">${label})</span> ${opt.replace(/^[A-E]\)\s*/, '')}
           </div>
         </div>`;
    });

    area.innerHTML += `
      <div class="question-card">
        <span class="question-title">${i+1}. ${q.question}</span>
        <div class="answer-grid" style="grid-template-columns: 1fr; border:none; padding-top:10px">
           ${optionsHTML}
        </div>
      </div>
    `;
  });

  area.innerHTML += `<button class="btn-primary" style="background:#10b981" onclick="evaluateAnswers()">CEVAPLARI DEƒûERLENDƒ∞R</button>`;
  area.innerHTML += `<div id="evalBox"></div>`;
}

async function evaluateAnswers() {
  log("Deƒüerlendiriliyor...", "inf");
  const prompt = `Sorular: ${JSON.stringify(questions)}\nKullanƒ±cƒ± Cevaplarƒ±: ${JSON.stringify(userAnswers)}\n\nL√ºtfen detaylƒ± analiz yap. Kullanƒ±cƒ±nƒ±n eksik bildiƒüi noktalarƒ± √ºr√ºn dok√ºmanƒ±na atƒ±fta bulunarak (√ñrn: √ñzel ≈ûartlar Madde 3) a√ßƒ±kla.`;
  
  const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${sessionKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "user", content: prompt }], temperature: 0.3 })
  });

  const data = await response.json();
  document.getElementById("evalBox").innerHTML = `<div class="evaluation-box">${data.choices[0].message.content}</div>`;
  log("Tamamlandƒ±.", "ok");
}
</script>
</body>
</html>
