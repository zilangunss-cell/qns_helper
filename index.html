<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Agesa ÃœrÃ¼n SimÃ¼latÃ¶rÃ¼ (PDF Destekli)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
body{margin:0;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;background:#f2f4f7;color:#333}
.container{display:grid;grid-template-columns:40% 60%;height:100vh;gap:16px;padding:16px;box-sizing:border-box}
.panel{background:#fff;border-radius:14px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,.08);position:relative;display:flex;flex-direction:column}
.scrollable{overflow-y:auto;flex-grow:1;padding-right:5px}
.question{border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:16px;background:#f8fafc}
.question b{color:#1e3a8a;display:block;margin-bottom:10px;font-size:16px}
label{font-weight:700;font-size:13px;color:#475569;margin-bottom:6px;display:block;margin-top:16px}
input[type="password"], select, input[type="file"] {width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px;box-sizing:border-box;font-family:inherit;background:#fff;font-size:14px}
button{margin-top:20px;width:100%;padding:14px;background:#2563eb;color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:background 0.2s;font-size:15px}
button:hover{background:#1d4ed8}
.secondary{background:#10b981;margin-top:0}
.secondary:hover{background:#059669}
.log-panel{background:#1e293b;color:#cbd5e1;border-radius:10px;padding:12px;font-size:12px;height:160px;overflow-y:auto;margin-top:auto;font-family:monospace}
.tab-header{display:flex;gap:15px;margin-bottom:10px;border-bottom:1px solid #334155;padding-bottom:8px}
.tab-header span{cursor:pointer;font-weight:600;opacity:0.6;transition:0.2s}
.tab-header span.active-tab{opacity:1;color:#38bdf8;border-bottom:2px solid #38bdf8}
.tab{display:none}
.tab.active{display:block}
.log-item{margin-bottom:4px; border-bottom:1px solid #334155; padding-bottom:2px;}
.log.ok{color:#4ade80} .log.info{color:#60a5fa} .log.error{color:#f87171}
.file-box{border:2px dashed #cbd5e1; padding:15px; border-radius:8px; text-align:center; background:#f8fafc}
</style>
</head>

<body>
<div class="container">

<div class="panel">
  <h2 style="margin-top:0;color:#0f172a">Agesa ÃœrÃ¼n Analiz</h2>

  <label>1. OpenAI API Key</label>
  <input id="apiKey" type="password" placeholder="sk-...">

  <label>2. Mod SeÃ§imi</label>
  <select id="modeSelect">
    <option value="standard">Standart Test (Ã–ÄŸretici)</option>
    <option value="hardcase">ğŸ›¡ï¸ Zorlu Vaka Analizi (DenetÃ§i Modu)</option>
  </select>

  <label>3. ÃœrÃ¼n DokÃ¼manÄ± (PDF)</label>
  <div class="file-box">
    <input id="pdfInput" type="file" accept="application/pdf">
    <div style="font-size:11px; color:#64748b; margin-top:5px">Sadece metin iÃ§eren PDF'ler (Ã–zel Åartlar vb.)</div>
  </div>

  <label>4. Ek GÃ¶rseller (Varsa)</label>
  <input id="images" type="file" accept="image/*" multiple>

  <button onclick="startAnalysis()">Analizi BaÅŸlat</button>

  <div class="log-panel">
    <div class="tab-header">
      <span onclick="switchTab('log')" id="logTabBtn" class="active-tab">Loglar</span>
      <span onclick="switchTab('eval')" id="evalTabBtn">Yapay Zeka Raporu</span>
    </div>
    <div id="logTab" class="tab active"></div>
    <div id="evalTab" class="tab"></div>
  </div>
</div>

<div class="panel">
  <div class="scrollable" id="output">
    <div style="text-align:center; margin-top:60px; color:#94a3b8">
      <h3>HazÄ±r Bekleniyor...</h3>
      <p>Sol taraftan PDF yÃ¼kleyip analizi baÅŸlatÄ±n.</p>
    </div>
  </div>
  
  <div id="actionArea" style="border-top:1px solid #e2e8f0; padding-top:15px; display:none">
    <div id="answerPanel" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;"></div>
    <button class="secondary" onclick="evaluateAnswers()">CevaplarÄ±mÄ± DeÄŸerlendir</button>
  </div>
</div>

</div>

<script>
// PDF.js Worker'Ä± TanÄ±mla
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

let sessionKey, questions=[], userAnswers={};

function log(msg, type="info"){
  const d=document.createElement("div");
  d.className="log-item log "+type;
  d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
  const logTab = document.getElementById("logTab");
  logTab.appendChild(d);
  logTab.scrollTop = logTab.scrollHeight;
}

function switchTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(tab+"Tab").classList.add("active");
  document.querySelectorAll('.tab-header span').forEach(s=>s.classList.remove('active-tab'));
  document.getElementById(tab+"TabBtn").classList.add("active-tab");
}

function toBase64(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

// --- PDF OKUMA FONKSÄ°YONU ---
async function readPDF(file) {
  log(`PDF YÃ¼kleniyor: ${file.name}`, "info");
  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
    let fullText = "";
    
    log(`Toplam ${pdf.numPages} sayfa tespit edildi. Okunuyor...`, "info");
    
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item => item.str).join(" ");
      fullText += `\n--- Sayfa ${i} ---\n` + pageText;
    }
    
    if(fullText.length < 50) {
      log("UYARI: PDF'ten metin okunamadÄ±! Dosya resim formatÄ±nda (taranmÄ±ÅŸ) olabilir.", "error");
      return null;
    }
    
    log("PDF baÅŸarÄ±yla metne Ã§evrildi.", "ok");
    return fullText;
  } catch (err) {
    log("PDF Okuma HatasÄ±: " + err.message, "error");
    throw err;
  }
}

// --- ANA Ä°ÅLEM ---
async function startAnalysis(){
  const apiKeyInput = document.getElementById("apiKey").value.trim();
  const pdfFile = document.getElementById("pdfInput").files[0];
  const imgFiles = [...document.getElementById("images").files];
  const mode = document.getElementById("modeSelect").value;
  
  // Temizlik
  document.getElementById("logTab").innerHTML="";
  document.getElementById("evalTab").innerHTML="";
  document.getElementById("actionArea").style.display="none";
  questions = [];
  userAnswers = {};

  // Validasyonlar
  if(!apiKeyInput) { log("LÃ¼tfen API Key giriniz.", "error"); return; }
  sessionKey = apiKeyInput;
  
  if(!pdfFile && imgFiles.length === 0) { log("LÃ¼tfen bir PDF dosyasÄ± seÃ§iniz.", "error"); return; }

  log("SÃ¼reÃ§ baÅŸlatÄ±ldÄ±...", "ok");

  try {
    // 1. PDF OKUMA
    let extractedText = "";
    if(pdfFile) {
      extractedText = await readPDF(pdfFile);
      if(!extractedText && imgFiles.length===0) return; // Metin yoksa ve resim yoksa dur
    }

    // 2. PROMPT HAZIRLIÄI
    let systemPrompt = "";
    if(mode === "hardcase") {
      systemPrompt = `Sen acÄ±masÄ±z bir Sigorta DenetÃ§isisin. 
      AÅŸaÄŸÄ±daki dokÃ¼manÄ± analiz et. KullanÄ±cÄ±yÄ± zorlamak iÃ§in "Ä°stisnalar", "Teminat DÄ±ÅŸÄ± Haller" ve "Limitler" Ã¼zerine kurulu 5 adet Vaka Analizi (Case Study) sorusu Ã¼ret.
      
      Ã–rnek tarz: "Ahmet Bey X oldu sanÄ±yor ama poliÃ§ede Y maddesi var. Ã–deme alÄ±r mÄ±?"
      Sorular zorlayÄ±cÄ± olmalÄ±.`;
    } else {
      systemPrompt = `Sen bir Sigorta EÄŸitmenisin. AÅŸaÄŸÄ±daki dokÃ¼manÄ± analiz et. ÃœrÃ¼nÃ¼n temel Ã¶zellikleri, kimleri kapsadÄ±ÄŸÄ± ve teminatlarÄ± hakkÄ±nda 10 adet Ã¶ÄŸretici Ã§oktan seÃ§meli soru Ã¼ret.`;
    }

    const content = [
      { 
        type: "text", 
        text: `${systemPrompt}
        
        FORMAT KURALI (KESÄ°N):
        Sadece geÃ§erli bir JSON Array dÃ¶ndÃ¼r. Markdown ('''json) kullanma.
        
        Ã–rnek JSON YapÄ±sÄ±:
        [
          {
            "question": "Soru metni...",
            "options": ["A) ...", "B) ...", "C) ...", "D) ...", "E) ..."]
          }
        ]
        
        Ä°NCELENECEK METÄ°N:
        ${extractedText ? extractedText.substring(0, 50000) : "Metin yok, gÃ¶rsellere bak."}` 
        // Not: 50.000 karakter sÄ±nÄ±rÄ± koydum token limitini patlatmamak iÃ§in.
      }
    ];

    // GÃ¶rsel varsa ekle
    if(imgFiles.length > 0) {
      const imgs = await Promise.all(imgFiles.map(toBase64));
      imgs.forEach(i => content.push({type:"image_url",image_url:{url:"data:image/png;base64,"+i}}));
    }

    // 3. API Ä°STEÄÄ°
    log("Yapay Zeka sorularÄ± hazÄ±rlÄ±yor (15-30sn sÃ¼rebilir)...", "info");

    const r = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": "Bearer " + sessionKey, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "user", content }], temperature: 0.5 })
    });

    if(!r.ok) throw new Error("API HatasÄ±: " + r.statusText);

    const data = await r.json();
    let rawContent = data.choices[0].message.content;
    
    // Temizlik
    rawContent = rawContent.replace(/```json/g, "").replace(/```/g, "").trim();
    
    let parsedData;
    try { parsedData = JSON.parse(rawContent); } 
    catch(e) { throw new Error("AI format hatasÄ± yaptÄ±. Tekrar deneyin."); }

    // YapÄ± KontrolÃ¼
    if(parsedData.questions) parsedData = parsedData.questions;
    if(parsedData.sorular) parsedData = parsedData.sorular;
    if(!Array.isArray(parsedData)) throw new Error("Gelen veri dizi formatÄ±nda deÄŸil.");

    questions = parsedData;
    log(`BaÅŸarÄ±lÄ±! ${questions.length} soru oluÅŸturuldu.`, "ok");
    
    renderUI();

  } catch (err) {
    console.error(err);
    log("HATA: " + err.message, "error");
  }
}

function renderUI(){
  const out = document.getElementById("output");
  const modeName = document.getElementById("modeSelect").options[document.getElementById("modeSelect").selectedIndex].text;
  
  out.innerHTML = `<h2 style="color:#2563eb; margin-bottom:20px">${modeName}</h2>`;
  
  questions.forEach((q, i) => {
    out.innerHTML += `
    <div class="question">
      <b>${i+1}. ${q.question}</b>
      ${q.options.map(opt => `<div style="padding:5px 0; border-top:1px solid #eee; color:#334155">${opt}</div>`).join('')}
    </div>`;
  });

  // Cevap panelini hazÄ±rla
  const ansPanel = document.getElementById("answerPanel");
  ansPanel.innerHTML = "";
  questions.forEach((_, i) => {
    ansPanel.innerHTML += `
    <div style="background:#f1f5f9; padding:8px 12px; border-radius:6px; border:1px solid #cbd5e1; display:flex; align-items:center; gap:5px">
      <strong>${i+1}</strong>
      ${['A','B','C','D','E'].map(L => `<label style="margin:0;cursor:pointer;font-weight:normal"><input type="radio" name="q${i}" onchange="userAnswers[${i+1}]='${L}'"> ${L}</label>`).join('')}
    </div>`;
  });

  document.getElementById("actionArea").style.display = "block";
}

async function evaluateAnswers(){
  log("Cevaplar deÄŸerlendiriliyor...", "info");
  
  const prompt = `
  ANALÄ°Z RAPORU:
  Sorular: ${JSON.stringify(questions)}
  KullanÄ±cÄ± CevaplarÄ±: ${JSON.stringify(userAnswers)}
  
  GÃ–REV:
  1. DoÄŸru cevaplarÄ± aÃ§Ä±kla.
  2. KullanÄ±cÄ±nÄ±n hatalarÄ±nÄ± "PoliÃ§e Maddesi/MantÄ±ÄŸÄ±" ile dÃ¼zelt.
  3. 100 Ã¼zerinden puan ver.
  4. Profesyonel ve yapÄ±cÄ± ol.
  `;

  try {
    const r = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": "Bearer " + sessionKey, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "user", content: prompt }], temperature: 0.3 })
    });

    const data = await r.json();
    document.getElementById("evalTab").innerHTML = `<pre style="white-space:pre-wrap; font-family:inherit; line-height:1.6">${data.choices[0].message.content}</pre>`;
    switchTab("eval");
    log("DeÄŸerlendirme tamamlandÄ±.", "ok");
  } catch(e) {
    log("DeÄŸerlendirme hatasÄ±: " + e.message, "error");
  }
}
</script>
</body>
</html>
