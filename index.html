<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agesa √úr√ºn Sim√ºlat√∂r√º - Multi PDF</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
  body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; }
  
  .header-bar { background: linear-gradient(90deg, #bf2d30 0%, #a61a1d 100%); color: white; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  .header-bar h1 { margin: 0; font-size: 22px; font-weight: 600; letter-spacing: 0.5px; }
  .badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 12px; }

  .container { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; height: calc(100vh - 70px); box-sizing: border-box; }

  .sidebar { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
  
  .input-group { margin-bottom: 5px; }
  .input-group label { display: block; font-weight: 600; font-size: 13px; color: #65676b; margin-bottom: 6px; }
  
  input[type="password"], select { width: 100%; padding: 12px; border: 1px solid #dddfe2; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border 0.2s; }
  input:focus, select:focus { border-color: #bf2d30; outline: none; }

  .file-upload-box { border: 2px dashed #bf2d30; background: #fff5f5; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; position: relative; transition: all 0.2s; }
  .file-upload-box:hover { background: #ffebeb; }
  .file-upload-box p { margin: 10px 0 0; font-size: 13px; color: #bf2d30; font-weight: 600; }
  .file-upload-box input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
  
  .file-list { font-size: 12px; color: #666; margin-top: 5px; text-align: left; }

  .btn-primary { background: #bf2d30; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; width: 100%; margin-top: 10px; transition: background 0.2s; }
  .btn-primary:hover { background: #961518; }
  
  .log-console { background: #242526; color: #b0b3b8; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 11px; flex-grow: 1; overflow-y: auto; margin-top: 10px; max-height: 200px; }
  .log-line { border-bottom: 1px solid #3a3b3c; padding: 4px 0; }
  .log-ok { color: #42b72a; } .log-err { color: #f02849; } .log-inf { color: #1877f2; }

  .main-content { background: white; border-radius: 12px; padding: 30px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  .empty-state { text-align: center; color: #65676b; margin-top: 100px; }
  
  .question-card { background: #f7f8fa; border: 1px solid #dddfe2; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
  .question-title { color: #1c1e21; font-weight: 700; margin-bottom: 15px; display: block; }
  .option { padding: 8px 12px; margin-bottom: 5px; background: white; border: 1px solid #ebedf0; border-radius: 6px; font-size: 14px; color: #4b4c4f; }
  
  .answer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
  .answer-item { background: #f0f2f5; padding: 10px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; font-size: 13px; font-weight: 600; }
  
  .evaluation-box { background: #e7f3ff; color: #0c3d69; padding: 20px; border-radius: 8px; margin-top: 20px; line-height: 1.6; white-space: pre-wrap; border-left: 5px solid #1877f2; }
</style>
</head>
<body>

<div class="header-bar">
  <h1>üõ°Ô∏è Agesa √úr√ºn Sim√ºlat√∂r√º</h1>
  <span class="badge">V2.1 - Multi PDF</span>
</div>

<div class="container">
  
  <div class="sidebar">
    <div class="input-group">
      <label>1. OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>

    <div class="input-group">
      <label>2. √áalƒ±≈üma Modu</label>
      <select id="modeSelect">
        <option value="standard">üéì √ñƒüretici Mod (Genel Bilgi)</option>
        <option value="hardcase">üî• Denet√ßi Modu (Zorlu Vakalar)</option>
      </select>
    </div>

    <div class="input-group">
      <label>3. √úr√ºn Dok√ºmanlarƒ± (PDF)</label>
      <div class="file-upload-box">
        <span style="font-size: 24px;">üìÑ</span>
        <p>PDF'leri Se√ßmek ƒ∞√ßin Tƒ±kla</p>
        <small style="color:#999">(CTRL ile √ßoklu se√ßim yapabilirsin)</small>
        <input type="file" id="pdfInput" accept="application/pdf" multiple onchange="handlePDFSelection(this)">
      </div>
      <div id="fileListDisplay" class="file-list"></div>
    </div>

    <div class="input-group">
      <label>4. Ekran G√∂r√ºnt√ºs√º (Opsiyonel)</label>
      <input type="file" id="imgInput" accept="image/*" multiple>
    </div>

    <button class="btn-primary" onclick="startProcess()">ANALƒ∞Zƒ∞ BA≈ûLAT</button>

    <div class="log-console" id="logger">
      <div class="log-line">Sistem hazƒ±r. PDF'leri y√ºkleyip ba≈ülayƒ±n...</div>
    </div>
  </div>

  <div class="main-content" id="outputArea">
    <div class="empty-state">
      <h2>Hen√ºz Analiz Yok</h2>
      <p>Sol taraftan PDF'lerinizi se√ßip analizi ba≈ülatƒ±n.</p>
    </div>
  </div>

</div>

<script>
// PDF Worker Ayarƒ±
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

let sessionKey = "";
let questions = [];
let userAnswers = {};

function log(msg, type) {
  const box = document.getElementById("logger");
  const div = document.createElement("div");
  div.className = `log-line log-${type}`;
  div.innerText = `> ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

// Dosya Se√ßimi G√∂stergesi
function handlePDFSelection(input) {
  const display = document.getElementById("fileListDisplay");
  if (input.files && input.files.length > 0) {
    let names = [];
    for(let i=0; i<input.files.length; i++) {
        names.push("‚Ä¢ " + input.files[i].name);
    }
    display.innerHTML = names.join("<br>");
    log(`${input.files.length} adet PDF se√ßildi.`, "inf");
  } else {
    display.innerHTML = "";
  }
}

// TEKƒ∞L PDF OKUMA
async function parsePDF(file) {
  log(`Okunuyor: ${file.name}...`, "inf");
  try {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(buffer).promise;
    let fullText = "";
    
    for(let i=1; i<=pdf.numPages; i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const strings = content.items.map(item => item.str);
      fullText += `\n--- [${file.name} - Sayfa ${i}] ---\n` + strings.join(" ");
    }
    
    if(fullText.length < 50) {
      log(`UYARI: ${file.name} dosyasƒ±ndan metin alƒ±namadƒ±.`, "err");
      return "";
    }
    return fullText;
  } catch(e) {
    log(`Hata (${file.name}): ` + e.message, "err");
    return "";
  }
}

function toBase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(file);
  });
}

// ANA ƒ∞≈ûLEM BA≈ûLATMA
async function startProcess() {
  document.getElementById("outputArea").innerHTML = '<div class="empty-state"><h3>Analiz Ediliyor...</h3><p>L√ºtfen bekleyiniz, yapay zeka dok√ºmanlarƒ± okuyor.</p></div>';
  questions = [];
  userAnswers = {};

  const key = document.getElementById("apiKey").value.trim();
  const pdfFiles = document.getElementById("pdfInput").files;
  const imgFiles = document.getElementById("imgInput").files;
  const mode = document.getElementById("modeSelect").value;

  if(!key) { log("L√ºtfen API Key giriniz!", "err"); return; }
  sessionKey = key;

  if(pdfFiles.length === 0 && imgFiles.length === 0) { log("L√ºtfen en az bir dosya se√ßin.", "err"); return; }

  try {
    // 1. T√úM PDF'LERƒ∞ OKU VE Bƒ∞RLE≈ûTƒ∞R
    let combinedText = "";
    if(pdfFiles.length > 0) {
      log(`${pdfFiles.length} adet PDF i≈üleniyor...`, "inf");
      for (let i = 0; i < pdfFiles.length; i++) {
        const text = await parsePDF(pdfFiles[i]);
        combinedText += text + "\n\n====================\n\n";
      }
      log(`T√ºm PDF'ler birle≈ütirildi (${combinedText.length} karakter).`, "ok");
    }
    
    // 2. RESƒ∞MLERƒ∞ HAZIRLA
    let imageList = [];
    if(imgFiles.length > 0) {
      for(let f of imgFiles) imageList.push(await toBase64(f));
      log(`${imageList.length} g√∂rsel i≈ülendi.`, "ok");
    }

    // 3. PROMPT HAZIRLIƒûI
    let promptText = "";
    if(mode === "hardcase") {
      promptText = `Sen uzman bir sigorta denet√ßisisin.
      A≈üaƒüƒ±daki Bƒ∞RDEN FAZLA dok√ºmanƒ± analiz et (√ñzel ≈ûartlar, Bilgilendirme Formlarƒ± vb. birle≈üik olabilir).
      
      G√ñREV: Kullanƒ±cƒ±yƒ± zorlayacak 5 adet "Vaka Analizi" (Case Study) sorusu √ºret.
      - Sorular √∂zellikle "Kapsam Dƒ±≈üƒ± Haller", "Limitler" ve "√ñzel ≈ûartlar" arasƒ±ndaki √ßeli≈ükilere odaklansƒ±n.
      - Basit tanƒ±m sorularƒ± sorma. Senaryo kur.`;
    } else {
      promptText = `Bu sigorta dok√ºmanlarƒ±nƒ± analiz et. √úr√ºn√º √∂ƒürenmek isteyen bir personel i√ßin 10 adet kaliteli, √∂ƒüretici √ßoktan se√ßmeli soru hazƒ±rla.`;
    }

    const messages = [
      {
        role: "user",
        content: [
          { type: "text", text: `${promptText}\n\n√áIKTI FORMATI: Sadece JSON Array d√∂nd√ºr. Markdown kullanma. Format: [{"question":"...","options":["A)...","B)..."]}] \n\nDOK√úMAN ƒ∞√áERƒ∞ƒûƒ∞:\n${combinedText.substring(0, 50000)}` },
          ...imageList.map(img => ({ type: "image_url", image_url: { url: `data:image/jpeg;base64,${img}` } }))
        ]
      }
    ];

    log("OpenAI'a g√∂nderiliyor (Bu i≈ülem biraz s√ºrebilir)...", "inf");
    
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${sessionKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o", messages: messages, temperature: 0.5 })
    });

    if(!response.ok) throw new Error("API Hatasƒ±: " + response.statusText);

    const data = await response.json();
    let content = data.choices[0].message.content.replace(/```json|```/g, "").trim();
    
    try {
      let parsed = JSON.parse(content);
      if(parsed.questions) parsed = parsed.questions;
      if(parsed.sorular) parsed = parsed.sorular;
      questions = parsed;
    } catch(e) {
      throw new Error("JSON Format Hatasƒ±. Tekrar deneyin.");
    }

    log(`${questions.length} soru olu≈üturuldu.`, "ok");
    renderUI();

  } catch(e) {
    log("Hata: " + e.message, "err");
    document.getElementById("outputArea").innerHTML = `<div class="empty-state" style="color:red"><h3>Hata Olu≈ütu</h3><p>${e.message}</p></div>`;
  }
}

function renderUI() {
  const area = document.getElementById("outputArea");
  area.innerHTML = `<h2>Sim√ºlasyon Sorularƒ±</h2>`;
  
  questions.forEach((q, i) => {
    area.innerHTML += `
      <div class="question-card">
        <span class="question-title">${i+1}. ${q.question}</span>
        ${q.options.map(opt => `<div class="option">${opt}</div>`).join('')}
        
        <div class="answer-grid" style="border:none; padding:0; margin-top:10px">
           ${['A','B','C','D','E'].map(L => `
             <div class="answer-item">
               <label style="cursor:pointer; width:100%; display:block">
                 <input type="radio" name="q${i}" onchange="userAnswers[${i+1}]='${L}'"> ${L}
               </label>
             </div>
           `).join('')}
        </div>
      </div>
    `;
  });

  area.innerHTML += `<button class="btn-primary" style="background:#10b981" onclick="evaluateAnswers()">CEVAPLARI DEƒûERLENDƒ∞R</button>`;
  area.innerHTML += `<div id="evalBox"></div>`;
}

async function evaluateAnswers() {
  log("Cevaplar deƒüerlendiriliyor...", "inf");
  const prompt = `Sorular: ${JSON.stringify(questions)}\nKullanƒ±cƒ± Cevaplarƒ±: ${JSON.stringify(userAnswers)}\n\nL√ºtfen detaylƒ± analiz yap. Doƒüru cevaplarƒ± a√ßƒ±kla ve kullanƒ±cƒ± hatalarƒ±nƒ± d√ºzelt. 100 √ºzerinden puan ver.`;
  
  const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${sessionKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "user", content: prompt }], temperature: 0.3 })
  });

  const data = await response.json();
  document.getElementById("evalBox").innerHTML = `<div class="evaluation-box">${data.choices[0].message.content}</div>`;
  log("Deƒüerlendirme tamamlandƒ±.", "ok");
}
</script>
</body>
</html>
