<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sim√ºlat√∂r - Hibrit Mod</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
  /* GENEL AYARLAR ve LACƒ∞VERT TEMA */
  body { 
    margin: 0; 
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
    background-color: #001E4D; /* ƒ∞stenen Lacivert Arka Plan */
    color: #e0e0e0; 
    height: 100vh;
    overflow: hidden; /* Sayfa kaydƒ±rmayƒ± engelle, i√ßerik kayar */
  }
  
  /* Container artƒ±k tam sayfa √ß√ºnk√º header yok */
  .container { 
    display: grid; 
    grid-template-columns: 350px 1fr; 
    gap: 20px; 
    padding: 20px; 
    height: 100vh; 
    box-sizing: border-box; 
  }

  /* SOL PANEL (Koyu Tema) */
  .sidebar { 
    background: #002855; 
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
    display: flex; 
    flex-direction: column; 
    gap: 15px; 
    overflow-y: auto; 
    border: 1px solid #003875;
  }
  
  .input-group label { display: block; font-weight: 600; font-size: 13px; color: #b0c4de; margin-bottom: 6px; }
  input[type="password"], select { 
    width: 100%; padding: 12px; 
    border: 1px solid #405d85; 
    background: #001E4D; 
    color: white;
    border-radius: 8px; font-size: 14px; box-sizing: border-box; 
  }
  
  /* DOSYA Y√úKLEME KUTULARI */
  .file-upload-box { 
    border: 2px dashed #405d85; 
    background: rgba(64, 93, 133, 0.1); 
    border-radius: 10px; 
    padding: 15px; 
    text-align: center; 
    cursor: pointer; 
    position: relative; 
    transition: all 0.2s; 
    color: #e0e0e0;
  }
  .file-upload-box:hover { background: rgba(64, 93, 133, 0.2); border-color: #6688b3; }
  .file-upload-box input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
  
  /* G√∂rsel kutusu i√ßin √∂zel renk (ayƒ±rt edici olsun) */
  .img-box { border-color: #bf2d30; background: rgba(191, 45, 48, 0.1); }
  .img-box:hover { background: rgba(191, 45, 48, 0.2); }

  .btn-primary { background: #bf2d30; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.2s; }
  .btn-primary:hover { background: #ff4d4f; box-shadow: 0 0 10px rgba(255, 77, 79, 0.5); }
  
  .log-console { background: #00091a; color: #00ff88; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 11px; flex-grow: 1; overflow-y: auto; margin-top: 10px; max-height: 150px; border: 1px solid #333; }
  .log-line { border-bottom: 1px solid #1a2733; padding: 4px 0; }
  .log-err { color: #ff4d4f; } .log-inf { color: #4db8ff; }

  /* SAƒû PANEL */
  .main-content { 
    background: #fdfdfd; 
    color: #1c1e21; 
    border-radius: 12px; 
    padding: 30px; 
    overflow-y: auto; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
  }
  
  .question-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
  .question-title { color: #111827; font-weight: 700; margin-bottom: 15px; display: block; font-size: 17px; line-height: 1.5; }
  
  .answer-item { 
    background: #f9fafb; padding: 12px 15px; border: 1px solid #e5e7eb; border-radius: 8px; 
    margin-bottom: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; color: #333;
  }
  .answer-item:hover { background: #f3f4f6; border-color: #d1d5db; }
  .answer-item.selected { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }
  .answer-item.correct { background: #dcfce7 !important; border-color: #22c55e !important; color: #166534 !important; }
  .answer-item.wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; opacity: 0.8; }
  
  .proof-box { 
    margin-top: 15px; padding: 15px; background: #fffbeb; border-left: 4px solid #f59e0b; 
    border-radius: 4px; font-size: 14px; color: #92400e; display: none; line-height: 1.5;
  }
</style>
</head>
<body>

<div class="container">
  
  <div class="sidebar">
    <div class="input-group">
      <label>1. OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>

    <div class="input-group">
      <label>2. Soru Tipi</label>
      <select id="modeSelect">
        <option value="strict">üéØ Kanƒ±tlƒ± Analiz (Strict)</option>
        <option value="hardcase">üî• Zorlayƒ±cƒ± Senaryolar</option>
      </select>
    </div>

    <div class="input-group">
      <label>3. G√∂rsel Y√ºkle (Resim)</label>
      <div class="file-upload-box img-box">
        <span style="font-size: 24px;">üñºÔ∏è</span>
        <p>G√∂rsel Se√ß</p>
        <input type="file" id="imageInput" accept="image/*" multiple onchange="handleFiles(this, 'imgList')">
      </div>
      <div id="imgList" style="font-size:11px; margin-top:5px; color:#aecbe8"></div>
    </div>

    <div class="input-group">
      <label>4. √úr√ºn Dok√ºmanlarƒ± (PDF)</label>
      <div class="file-upload-box">
        <span style="font-size: 24px;">üìÑ</span>
        <p>PDF Se√ß</p>
        <input type="file" id="pdfInput" accept="application/pdf" multiple onchange="handleFiles(this, 'pdfList')">
      </div>
      <div id="pdfList" style="font-size:11px; margin-top:5px; color:#aecbe8"></div>
    </div>

    <button class="btn-primary" onclick="startProcess()">ANALƒ∞Zƒ∞ BA≈ûLAT</button>
    <div class="log-console" id="logger"><div class="log-line">Sistem hazƒ±r.</div></div>
  </div>

  <div class="main-content" id="outputArea">
    <div style="text-align:center; margin-top:100px; color:#6b7280">
      <img src="https://cdn-icons-png.flaticon.com/512/3342/3342137.png" width="80" style="opacity:0.5; margin-bottom:20px">
      <h3>Bekleniyor...</h3>
      <p>Sol taraftan G√∂rsel veya PDF y√ºkleyerek analizi ba≈ülatƒ±n.</p>
    </div>
  </div>

</div>

<script>
// PDF Worker Ayarƒ±
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

let questions = []; 
let userAnswers = {};

function log(msg, type) {
  const box = document.getElementById("logger");
  const div = document.createElement("div");
  div.className = `log-line log-${type}`;
  div.innerText = `> ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function handleFiles(input, listId) {
  const list = document.getElementById(listId);
  if (input.files.length > 0) {
    list.innerHTML = Array.from(input.files).map(f => "‚Ä¢ " + f.name).join("<br>");
    log(`${input.files.length} dosya eklendi (${listId}).`, "inf");
  }
}

// G√∂rsel -> Base64
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});

// PDF -> Text
async function parsePDF(file) {
  log(`PDF Okunuyor: ${file.name}`, "inf");
  try {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(buffer).promise;
    let fullText = "";
    for(let i=1; i<=pdf.numPages; i++){
      const page = await pdf.getPage(i);
      const text = await page.getTextContent();
      fullText += `\n[PDF: ${file.name} - Sayfa ${i}] ` + text.items.map(s => s.str).join(" ");
    }
    return fullText;
  } catch(e) {
    log("PDF Hatasƒ±: " + e.message, "err");
    return "";
  }
}

async function startProcess() {
  const area = document.getElementById("outputArea");
  
  const rawKey = document.getElementById("apiKey").value;
  const key = rawKey.replace(/[^\x00-\x7F]/g, "").trim();
  document.getElementById("apiKey").value = key;

  if(!key) { log("API Key girilmedi!", "err"); return; }
  
  const imgFiles = document.getElementById("imageInput").files;
  const pdfFiles = document.getElementById("pdfInput").files;
  
  if(imgFiles.length === 0 && pdfFiles.length === 0) { 
    log("Hi√ßbir dosya (Resim veya PDF) se√ßilmedi!", "err"); 
    return; 
  }

  area.innerHTML = '<div style="text-align:center;margin-top:50px"><h3>Analiz Yapƒ±lƒ±yor...</h3><p>Yapay zeka y√ºklenen t√ºm kaynaklarƒ± (PDF + G√∂rsel) inceliyor.</p></div>';
  questions = [];
  userAnswers = {};

  try {
    let apiContent = [];
    
    // 1. PDF METƒ∞NLERƒ∞Nƒ∞ HAZIRLA
    let pdfContextText = "";
    if (pdfFiles.length > 0) {
        log("PDF'ler metne d√∂n√º≈üt√ºr√ºl√ºyor...", "inf");
        for(let i=0; i<pdfFiles.length; i++) {
            pdfContextText += await parsePDF(pdfFiles[i]) + "\n\n";
        }
    }

    // 2. PROMPT METNƒ∞Nƒ∞ OLU≈ûTUR
    let systemPrompt = `
      Sen uzman bir Sigorta Denet√ßisisin. 
      Sana verilen g√∂rselleri ve/veya PDF metinlerini analiz et.
      
      G√ñREV:
      Bu dok√ºmanlardaki bilgilere dayanarak 5 adet zorlayƒ±cƒ±, √ßoktan se√ßmeli soru √ºret.
      
      METƒ∞N KAYNAKLARI (PDF):
      ${pdfContextText.length > 0 ? pdfContextText.substring(0, 30000) : "PDF y√ºklenmedi."}
      
      KURALLAR:
      1. Hem g√∂rsellerdeki hem de metindeki bilgileri kullan.
      2. Asla dok√ºman dƒ±≈üƒ± bilgi uydurma.
      3. Yanƒ±tƒ± sadece saf JSON formatƒ±nda ver (Markdown yok).
      
      JSON FORMATI:
      {
        "questions": [
          {
            "question": "Soru...",
            "options": ["A) ...", "B) ...", "C) ...", "D) ...", "E) ..."],
            "correct_option": "A",
            "proof": "Bu bilgi G√∂rsel 1'de veya PDF Sayfa 2'de a√ßƒ±k√ßa ge√ßmektedir."
          }
        ]
      }
    `;

    // Promptu i√ßeriƒüe ekle
    apiContent.push({ type: "text", text: systemPrompt });

    // 3. G√ñRSELLERƒ∞ EKLE
    if (imgFiles.length > 0) {
        log("G√∂rseller i≈üleniyor...", "inf");
        for (let i = 0; i < imgFiles.length; i++) {
            const base64Data = await toBase64(imgFiles[i]);
            apiContent.push({
                type: "image_url",
                image_url: { url: base64Data, detail: "high" }
            });
        }
    }

    // 4. API √áAƒûRISI
    log("OpenAI'a g√∂nderiliyor (Hibrit Mod)...", "inf");
    
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "gpt-4o", 
        messages: [{ role: "user", content: apiContent }],
        max_tokens: 3000,
        temperature: 0.2
      })
    });

    if(!res.ok) {
        const errData = await res.json();
        throw new Error(errData.error?.message || "API Hatasƒ±");
    }

    const data = await res.json();
    let content = data.choices[0].message.content;
    content = content.replace(/```json/g, "").replace(/```/g, "").trim();
    
    const parsedData = JSON.parse(content);
    questions = parsedData.questions || parsedData;

    log(`${questions.length} soru ba≈üarƒ±yla √ºretildi.`, "ok");
    renderQuiz();

  } catch(e) {
    log("Hata: " + e.message, "err");
    area.innerHTML = `<h3 style="color:red; text-align:center">Hata Olu≈ütu</h3><p style="text-align:center">${e.message}</p>`;
  }
}

function renderQuiz() {
  const area = document.getElementById("outputArea");
  area.innerHTML = `<h2 style="border-bottom:2px solid #bf2d30; padding-bottom:10px">üìù Analiz Sonu√ßlarƒ± & Sorular</h2>`;
  
  questions.forEach((q, idx) => {
    let optsHTML = "";
    const letters = ["A","B","C","D","E"];
    
    q.options.forEach((opt, oIdx) => {
      const letter = letters[oIdx];
      const cleanOpt = opt.replace(/^[A-Ea-e][\).]\s*/, "");
      
      optsHTML += `
        <div class="answer-item" id="opt_${idx}_${letter}" onclick="selectAnswer(${idx}, '${letter}')">
          <b style="color:#bf2d30; margin-right:10px; width:20px">${letter})</b> ${cleanOpt}
        </div>
      `;
    });

    area.innerHTML += `
      <div class="question-card" id="q_card_${idx}">
        <span class="question-title">${idx+1}. ${q.question}</span>
        <div>${optsHTML}</div>
        <div class="proof-box" id="proof_${idx}">
          <strong>üîç Kaynak Kanƒ±tƒ±:</strong>
          ${q.proof || "Dok√ºmanda tespit edildi."}
        </div>
      </div>
    `;
  });

  area.innerHTML += `<button class="btn-primary" style="background:#10b981; margin-bottom:50px" onclick="checkAnswers()">TESTƒ∞ Bƒ∞Tƒ∞R VE KONTROL ET</button>`;
}

function selectAnswer(qIdx, letter) {
  const parent = document.getElementById(`q_card_${qIdx}`);
  const items = parent.querySelectorAll('.answer-item');
  items.forEach(i => i.classList.remove('selected'));
  
  document.getElementById(`opt_${qIdx}_${letter}`).classList.add('selected');
  userAnswers[qIdx] = letter;
}

function checkAnswers() {
  let score = 0;
  questions.forEach((q, idx) => {
    const userAns = userAnswers[idx];
    const correctAns = q.correct_option.trim().toUpperCase(); 
    const proofBox = document.getElementById(`proof_${idx}`);
    
    proofBox.style.display = "block";
    
    const letters = ["A","B","C","D","E"];
    letters.slice(0, q.options.length).forEach(L => {
      const el = document.getElementById(`opt_${idx}_${L}`);
      
      if(L === correctAns) el.classList.add('correct');
      if(userAns === L && userAns !== correctAns) el.classList.add('wrong');
    });

    if(userAns === correctAns) score++;
  });

  window.scrollTo(0,0);
  alert(`Analiz Tamamlandƒ±!\nDoƒüru: ${score} / ${questions.length}`);
}
</script>
</body>
</html>
