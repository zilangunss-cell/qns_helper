<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agesa GÃ¶rsel Analiz SimÃ¼latÃ¶rÃ¼</title>

<style>
  /* GENEL AYARLAR ve LACÄ°VERT TEMA */
  body { 
    margin: 0; 
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
    background-color: #001E4D; /* Ä°stenen Lacivert Arka Plan */
    color: #e0e0e0; 
  }
  
  .header-bar { 
    background: linear-gradient(90deg, #bf2d30 0%, #8a1c1e 100%); 
    color: white; 
    padding: 15px 30px; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.4); 
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .header-bar h1 { margin: 0; font-size: 22px; font-weight: 600; letter-spacing: 0.5px; }
  .badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 12px; }

  .container { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; height: calc(100vh - 70px); box-sizing: border-box; }

  /* SOL PANEL (Koyu Tema) */
  .sidebar { 
    background: #002855; /* Panel iÃ§in biraz daha aÃ§Ä±k lacivert */
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
    display: flex; 
    flex-direction: column; 
    gap: 15px; 
    overflow-y: auto; 
    border: 1px solid #003875;
  }
  
  .input-group label { display: block; font-weight: 600; font-size: 13px; color: #b0c4de; margin-bottom: 6px; }
  input[type="password"], select { 
    width: 100%; padding: 12px; 
    border: 1px solid #405d85; 
    background: #001E4D; 
    color: white;
    border-radius: 8px; font-size: 14px; box-sizing: border-box; 
  }
  
  /* DOSYA YÃœKLEME KUTUSU (GÃ¶rsel Ä°Ã§in) */
  .file-upload-box { 
    border: 2px dashed #bf2d30; 
    background: rgba(191, 45, 48, 0.1); 
    border-radius: 10px; 
    padding: 20px; 
    text-align: center; 
    cursor: pointer; 
    position: relative; 
    transition: all 0.2s; 
    color: #e0e0e0;
  }
  .file-upload-box:hover { background: rgba(191, 45, 48, 0.2); }
  .file-upload-box input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
  
  .btn-primary { background: #bf2d30; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.2s; }
  .btn-primary:hover { background: #ff4d4f; box-shadow: 0 0 10px rgba(255, 77, 79, 0.5); }
  
  .log-console { background: #00091a; color: #00ff88; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 11px; flex-grow: 1; overflow-y: auto; margin-top: 10px; max-height: 200px; border: 1px solid #333; }
  .log-line { border-bottom: 1px solid #1a2733; padding: 4px 0; }
  .log-err { color: #ff4d4f; } .log-inf { color: #4db8ff; }

  /* SAÄ PANEL (SonuÃ§ AlanÄ± - Okunabilirlik iÃ§in AÃ§Ä±k Renk) */
  .main-content { 
    background: #fdfdfd; 
    color: #1c1e21; /* Metin rengi siyah kalsÄ±n ki okunsun */
    border-radius: 12px; 
    padding: 30px; 
    overflow-y: auto; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
  }
  
  .question-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
  .question-title { color: #111827; font-weight: 700; margin-bottom: 15px; display: block; font-size: 17px; line-height: 1.5; }
  
  .answer-item { 
    background: #f9fafb; padding: 12px 15px; border: 1px solid #e5e7eb; border-radius: 8px; 
    margin-bottom: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; color: #333;
  }
  .answer-item:hover { background: #f3f4f6; border-color: #d1d5db; }
  .answer-item.selected { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }
  
  .answer-item.correct { background: #dcfce7 !important; border-color: #22c55e !important; color: #166534 !important; }
  .answer-item.wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; opacity: 0.8; }
  
  .proof-box { 
    margin-top: 15px; padding: 15px; background: #fffbeb; border-left: 4px solid #f59e0b; 
    border-radius: 4px; font-size: 14px; color: #92400e; display: none; line-height: 1.5;
  }
</style>
</head>
<body>

<div class="header-bar">
  <h1>ğŸ›¡ï¸ Agesa GÃ¶rsel Analiz SimÃ¼latÃ¶rÃ¼</h1>
  <span class="badge">V5.0 - Image Vision</span>
</div>

<div class="container">
  
  <div class="sidebar">
    <div class="input-group">
      <label>1. OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>

    <div class="input-group">
      <label>2. Soru Tipi</label>
      <select id="modeSelect">
        <option value="strict">ğŸ¯ GÃ¶rsel KanÄ±tlÄ± (Strict)</option>
        <option value="hardcase">ğŸ”¥ ZorlayÄ±cÄ± Senaryolar</option>
      </select>
    </div>

    <div class="input-group">
      <label>3. ÃœrÃ¼n GÃ¶rselleri (Resim)</label>
      <div class="file-upload-box">
        <span style="font-size: 24px;">ğŸ–¼ï¸</span>
        <p>GÃ¶rselleri SeÃ§mek Ä°Ã§in TÄ±kla</p>
        <small style="color:#bbb; display:block; margin-top:5px">(SÄ±nÄ±rsÄ±z resim yÃ¼klenebilir)</small>
        <input type="file" id="imageInput" accept="image/*" multiple onchange="handleFiles(this)">
      </div>
      <div id="fileList" style="font-size:12px; margin-top:5px; color:#aecbe8"></div>
    </div>

    <button class="btn-primary" onclick="startProcess()">GÃ–RSELLERÄ° ANALÄ°Z ET</button>
    <div class="log-console" id="logger"><div class="log-line">Sistem hazÄ±r.</div></div>
  </div>

  <div class="main-content" id="outputArea">
    <div style="text-align:center; margin-top:100px; color:#6b7280">
      <img src="https://cdn-icons-png.flaticon.com/512/3342/3342137.png" width="80" style="opacity:0.5; margin-bottom:20px">
      <h3>Bekleniyor...</h3>
      <p>Sol taraftan Ã¼rÃ¼n broÅŸÃ¼rÃ¼ veya dokÃ¼man resimleri yÃ¼kleyin.</p>
    </div>
  </div>

</div>

<script>
let questions = []; 
let userAnswers = {};

function log(msg, type) {
  const box = document.getElementById("logger");
  const div = document.createElement("div");
  div.className = `log-line log-${type}`;
  div.innerText = `> ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function handleFiles(input) {
  const list = document.getElementById("fileList");
  if (input.files.length > 0) {
    list.innerHTML = Array.from(input.files).map(f => "â€¢ " + f.name).join("<br>");
    log(`${input.files.length} gÃ¶rsel seÃ§ildi.`, "inf");
  }
}

// GÃ¶rseli Base64 formatÄ±na Ã§eviren yardÄ±mcÄ± fonksiyon
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});

async function startProcess() {
  const area = document.getElementById("outputArea");
  area.innerHTML = '<div style="text-align:center;margin-top:50px"><h3>GÃ¶rseller Ä°ÅŸleniyor...</h3><p>Yapay zeka gÃ¶rselleri okuyor ve soru Ã¼retiyor. (GÃ¶rsel boyutuna gÃ¶re biraz sÃ¼rebilir)</p></div>';
  
  questions = [];
  userAnswers = {};

  const rawKey = document.getElementById("apiKey").value;
  const key = rawKey.replace(/[^\x00-\x7F]/g, "").trim();
  document.getElementById("apiKey").value = key;

  if(!key) { log("API Key girilmedi!", "err"); return; }
  
  const files = document.getElementById("imageInput").files;
  if(files.length === 0) { log("GÃ¶rsel yÃ¼klenmedi!", "err"); return; }

  try {
    // 1. GÃ–RSELLERÄ° HAZIRLA (Base64)
    log("GÃ¶rseller dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼yor...", "inf");
    let imageContent = [];
    
    // Metin talimatÄ±
    imageContent.push({
      type: "text", 
      text: `Sen bir Sigorta DenetÃ§isisin. AÅŸaÄŸÄ±daki gÃ¶rselleri analiz et ve 5 adet Ã§oktan seÃ§meli soru Ã¼ret.
      
      KURALLAR:
      1. Sadece gÃ¶rsellerde yer alan bilgileri sor.
      2. YanÄ±t formatÄ±n kesinlikle ÅŸu JSON yapÄ±sÄ±nda olmalÄ± (Markdown kullanma, sadece saf JSON):
      
      {
        "questions": [
          {
            "question": "Soru metni...",
            "options": ["A) ...", "B) ...", "C) ...", "D) ...", "E) ..."],
            "correct_option": "A",
            "proof": "GÃ¶rselde '...' baÅŸlÄ±ÄŸÄ± altÄ±nda aÃ§Ä±kÃ§a belirtilmiÅŸtir."
          }
        ]
      }`
    });

    // Her bir gÃ¶rseli ekle
    for (let i = 0; i < files.length; i++) {
        const base64Data = await toBase64(files[i]);
        imageContent.push({
            type: "image_url",
            image_url: {
                url: base64Data,
                detail: "high" // DetaylÄ± okuma iÃ§in
            }
        });
        log(`${i+1}. gÃ¶rsel hazÄ±rlandÄ±.`, "inf");
    }

    // 2. GPT-4o API Ã‡AÄRISI (Vision YeteneÄŸi)
    log("GPT-4o Vision'a gÃ¶nderiliyor...", "inf");
    
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "gpt-4o", // Vision destekleyen model
        messages: [
            {
                role: "user",
                content: imageContent
            }
        ],
        max_tokens: 2000,
        temperature: 0.2
      })
    });

    if(!res.ok) {
        const errData = await res.json();
        throw new Error(errData.error?.message || "API HatasÄ±");
    }

    const data = await res.json();
    let content = data.choices[0].message.content;
    
    // JSON temizleme (bazen ```json wrapper iÃ§inde gelir)
    content = content.replace(/```json/g, "").replace(/```/g, "").trim();
    
    const parsedData = JSON.parse(content);
    questions = parsedData.questions || parsedData; // DÃ¶nen yapÄ±ya gÃ¶re esneklik

    log(`${questions.length} soru baÅŸarÄ±yla Ã¼retildi.`, "ok");
    renderQuiz();

  } catch(e) {
    log("Hata: " + e.message, "err");
    area.innerHTML = `<h3 style="color:red; text-align:center">Hata OluÅŸtu</h3><p style="text-align:center">${e.message}</p>`;
  }
}

function renderQuiz() {
  const area = document.getElementById("outputArea");
  area.innerHTML = `<h2 style="border-bottom:2px solid #bf2d30; padding-bottom:10px">ğŸ“ GÃ¶rsel KaynaklÄ± Sorular (${questions.length})</h2>`;
  
  questions.forEach((q, idx) => {
    let optsHTML = "";
    const letters = ["A","B","C","D","E"];
    
    q.options.forEach((opt, oIdx) => {
      const letter = letters[oIdx];
      const cleanOpt = opt.replace(/^[A-Ea-e][\).]\s*/, "");
      
      optsHTML += `
        <div class="answer-item" id="opt_${idx}_${letter}" onclick="selectAnswer(${idx}, '${letter}')">
          <b style="color:#bf2d30; margin-right:10px; width:20px">${letter})</b> ${cleanOpt}
        </div>
      `;
    });

    area.innerHTML += `
      <div class="question-card" id="q_card_${idx}">
        <span class="question-title">${idx+1}. ${q.question}</span>
        <div>${optsHTML}</div>
        <div class="proof-box" id="proof_${idx}">
          <strong>ğŸ” GÃ¶rsel KanÄ±tÄ±:</strong>
          ${q.proof || "GÃ¶rselden tespit edildi."}
        </div>
      </div>
    `;
  });

  area.innerHTML += `<button class="btn-primary" style="background:#10b981; margin-bottom:50px" onclick="checkAnswers()">TESTÄ° BÄ°TÄ°R VE KONTROL ET</button>`;
}

function selectAnswer(qIdx, letter) {
  const parent = document.getElementById(`q_card_${qIdx}`);
  const items = parent.querySelectorAll('.answer-item');
  items.forEach(i => i.classList.remove('selected'));
  
  document.getElementById(`opt_${qIdx}_${letter}`).classList.add('selected');
  userAnswers[qIdx] = letter;
}

function checkAnswers() {
  let score = 0;
  questions.forEach((q, idx) => {
    const userAns = userAnswers[idx];
    const correctAns = q.correct_option.trim().toUpperCase(); 
    const proofBox = document.getElementById(`proof_${idx}`);
    
    proofBox.style.display = "block";
    
    const letters = ["A","B","C","D","E"];
    letters.slice(0, q.options.length).forEach(L => {
      const el = document.getElementById(`opt_${idx}_${L}`);
      
      if(L === correctAns) {
        el.classList.add('correct');
      }
      
      if(userAns === L && userAns !== correctAns) {
        el.classList.add('wrong');
      }
    });

    if(userAns === correctAns) score++;
  });

  window.scrollTo(0,0);
  alert(`Analiz TamamlandÄ±!\nDoÄŸru: ${score} / ${questions.length}`);
}
</script>
</body>
</html>
